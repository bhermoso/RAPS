<!DOCTYPE html>
<!--
================================================================================
REGISTRO DE ACTUACIONES DE PROMOCI√ìN DE LA SALUD (RAPS_DGRAMET) v4.0
Distrito Sanitario Granada-Metropolitano
================================================================================

MIT License

Copyright (c) 2025 BR Hermoso

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

---

NOTA SOBRE LOS DATOS:

Los datos de actuaciones, profesionales y unidades asistenciales procesados
por este software son propiedad del Distrito Sanitario Granada-Metropolitano
del Servicio Andaluz de Salud.

El c√≥digo del software est√° licenciado bajo MIT, pero los datos utilizados
est√°n sujetos a las pol√≠ticas de protecci√≥n de datos y propiedad del distrito
sanitario correspondiente.

================================================================================
Caracter√≠sticas principales:
- An√°lisis de datos de actividades de promoci√≥n de la salud
- Visualizaci√≥n interactiva con gr√°ficos y tablas
- Filtrado avanzado por m√∫ltiples criterios
- Exportaci√≥n a Excel y PDF
- An√°lisis por niveles: Global, Unidad, Profesional
- M√∫ltiples mejoras avanzadas: alertas, comparativas, correlaciones, etc.

Versi√≥n: 4.0
√öltima actualizaci√≥n: Octubre 2025
================================================================================
-->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Registro de actuaciones de promoci√≥n de la salud - An√°lisis por Distrito, Unidad y Profesional">
    <meta name="author" content="Distrito Sanitario Granada-Metropolitano">
    <title>Registro de actuaciones de promoci√≥n de la salud | DSGM v4.0 üöÄ</title>
    
    <!-- LIBRER√çAS EXTERNAS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- NUEVA: jsPDF para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- ESTILOS CSS -->
    <style>
        /* === VARIABLES CSS === */
        :root {
            --color-primario: #1976d2;
            --color-secundario: #388e3c;
            --color-acento1: #f57c00;
            --color-acento2: #d32f2f;
            --color-acento3: #9c27b0;
            --color-acento4: #0288d1;
            --color-exito: #4caf50;
            --color-advertencia: #ff9800;
            --color-peligro: #f44336;
            --color-fondo: #f8f9fa;
            --color-texto: #212529;
            --color-gris-claro: #e9ecef;
            --color-gris: #6c757d;
            --color-blanco: #ffffff;
            --sombra: 0 2px 8px rgba(0,0,0,0.1);
            --sombra-hover: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* === RESET Y BASE === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: var(--color-texto);
            background-color: var(--color-fondo);
        }
        
        /* === HEADER === */
        header {
            background: linear-gradient(135deg, var(--color-primario), #1565c0);
            color: var(--color-blanco);
            padding: 20px 30px;
            box-shadow: var(--sombra);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        header h1 {
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* === BOTONES === */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--color-blanco);
            color: var(--color-primario);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-hover);
        }
        
        .btn-secondary {
            background-color: rgba(255,255,255,0.2);
            color: var(--color-blanco);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn-secondary:hover {
            background-color: rgba(255,255,255,0.3);
        }
        
        /* === LAYOUT PRINCIPAL === */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        /* === PANEL DE NIVEL DE AN√ÅLISIS === */
        .nivel-panel {
            background: linear-gradient(135deg, var(--color-acento3), #7b1fa2);
            color: var(--color-blanco);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .nivel-panel h2 {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nivel-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .nivel-grupo label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .nivel-grupo select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            font-size: 14px;
            background-color: rgba(255,255,255,0.95);
            color: var(--color-texto);
            font-weight: 500;
        }
        
        .nivel-grupo select:focus {
            outline: none;
            border-color: var(--color-blanco);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }
        
        /* === PANEL DE FILTROS === */
        .filtros-panel {
            background: var(--color-blanco);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .filtros-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--color-primario);
        }
        
        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filtro-grupo label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--color-gris);
            font-size: 13px;
        }
        
        .filtro-grupo select,
        .filtro-grupo input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--color-gris-claro);
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* === TARJETAS KPI === */
        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: var(--color-blanco);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            border-left: 4px solid var(--color-primario);
            transition: transform 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--sombra-hover);
        }
        
        .kpi-card .icono {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .kpi-card .valor {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primario);
            margin-bottom: 5px;
        }
        
        .kpi-card .etiqueta {
            font-size: 13px;
            color: var(--color-gris);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .kpi-card .subtexto {
            font-size: 12px;
            color: var(--color-gris);
            margin-top: 5px;
        }
        
        /* === SECCI√ìN DE NIVEL ACTUAL === */
        .nivel-actual {
            background: var(--color-blanco);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
            border-left: 4px solid var(--color-acento3);
        }
        
        .nivel-actual h3 {
            font-size: 18px;
            color: var(--color-acento3);
            margin-bottom: 10px;
        }
        
        .nivel-actual .info {
            font-size: 16px;
            color: var(--color-texto);
            font-weight: 500;
        }
        
        /* === GR√ÅFICOS === */
        .graficos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .grafico-card {
            background: var(--color-blanco);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--sombra);
        }
        
        .grafico-card h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--color-primario);
        }
        
        .grafico-container {
            position: relative;
            height: 300px;
        }
        
        /* === RANKINGS === */
        .ranking-card {
            background: var(--color-blanco);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .ranking-card h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--color-primario);
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background-color: var(--color-fondo);
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }
        
        .ranking-item:hover {
            background-color: var(--color-gris-claro);
        }
        
        .ranking-posicion {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-primario);
            min-width: 40px;
            text-align: center;
        }
        
        .ranking-nombre {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            padding: 0 15px;
        }
        
        .ranking-valor {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-secundario);
        }
        
        .ranking-barra {
            flex: 1;
            height: 8px;
            background-color: var(--color-gris-claro);
            border-radius: 4px;
            margin: 0 15px;
            overflow: hidden;
        }
        
        .ranking-barra-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primario), var(--color-secundario));
            transition: width 0.5s ease;
        }
        
        /* === TABLA === */
        .tabla-container {
            background: var(--color-blanco);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            overflow-x: auto;
        }
        
        .tabla-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .tabla-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-primario);
        }
        
        .busqueda-input {
            padding: 8px 12px;
            border: 1px solid var(--color-gris-claro);
            border-radius: 4px;
            font-size: 14px;
            width: 300px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background-color: var(--color-primario);
            color: var(--color-blanco);
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--color-gris-claro);
            font-size: 14px;
        }
        
        tbody tr:hover {
            background-color: var(--color-fondo);
        }
        
        .paginacion-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .paginacion-info {
            color: var(--color-gris);
            font-size: 14px;
        }
        
        .paginacion-botones {
            display: flex;
            gap: 10px;
        }
        
        /* === PESTA√ëAS === */
        .tabs-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-gris-claro);
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background-color: var(--color-gris-claro);
            border: none;
            border-radius: 8px 8px 0 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--color-gris);
            transition: all 0.3s ease;
            position: relative;
            bottom: -2px;
        }
        
        .tab:hover {
            background-color: var(--color-fondo);
            color: var(--color-primario);
        }
        
        .tab.active {
            background-color: var(--color-blanco);
            color: var(--color-primario);
            border-bottom: 3px solid var(--color-primario);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* === LOADING === */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            border: 5px solid var(--color-gris-claro);
            border-top: 5px solid var(--color-primario);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* === UTILIDADES === */
        .text-center {
            text-align: center;
        }
        
        .mb-30 {
            margin-bottom: 30px;
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .graficos-grid {
                grid-template-columns: 1fr;
            }
            
            .filtros-grid {
                grid-template-columns: 1fr;
            }
            
            .nivel-selector {
                grid-template-columns: 1fr;
            }
            
            .kpis-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* === MEJORA 1: BOT√ìN EXCEL === */
        .btn-success {
            background-color: var(--color-exito);
            color: var(--color-blanco);
        }
        
        .btn-success:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: var(--sombra-hover);
        }
        
        /* === MEJORA 2: COMPARATIVAS TEMPORALES === */
        .comparativas-panel {
            background: var(--color-blanco);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .comparativas-panel h2 {
            font-size: 20px;
            color: var(--color-primario);
            margin-bottom: 15px;
        }
        
        .periodo-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .periodo-grupo {
            flex: 1;
            min-width: 200px;
        }
        
        .periodo-grupo label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--color-gris);
            font-size: 13px;
        }
        
        .periodo-grupo select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--color-gris-claro);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .comparativa-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .comparativa-card {
            background: var(--color-fondo);
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--color-primario);
        }
        
        .comparativa-label {
            font-size: 12px;
            color: var(--color-gris);
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .comparativa-valores {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .valor-actual {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-primario);
        }
        
        .valor-anterior {
            font-size: 16px;
            color: var(--color-gris);
        }
        
        .comparativa-cambio {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .cambio-positivo {
            color: var(--color-exito);
        }
        
        .cambio-negativo {
            color: var(--color-peligro);
        }
        
        .cambio-neutro {
            color: var(--color-gris);
        }
        
        /* === MEJORA 3: SISTEMA DE ALERTAS === */
        .alertas-panel {
            background: linear-gradient(135deg, var(--color-advertencia), #f57c00);
            color: var(--color-blanco);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .alertas-panel h2 {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alerta-item {
            background-color: rgba(255,255,255,0.15);
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid var(--color-blanco);
        }
        
        .alerta-icono {
            font-size: 24px;
            min-width: 30px;
        }
        
        .alerta-texto {
            flex: 1;
            font-size: 14px;
        }
        
        .alerta-nivel {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .alerta-alta {
            background-color: var(--color-peligro);
        }
        
        .alerta-media {
            background-color: var(--color-advertencia);
        }
        
        .alerta-baja {
            background-color: var(--color-exito);
        }
        
        /* === MEJORA 4: DASHBOARD PROFESIONAL === */
        .dashboard-profesional {
            background: linear-gradient(135deg, var(--color-acento3), #7b1fa2);
            color: var(--color-blanco);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .dashboard-profesional h2 {
            font-size: 22px;
            margin-bottom: 10px;
        }
        
        .profesional-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .profesional-metrica {
            background-color: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 6px;
        }
        
        .profesional-metrica-valor {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .profesional-metrica-label {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .profesional-metrica-comparativa {
            font-size: 12px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        /* === MEJORA 5: AN√ÅLISIS DE BRECHAS === */
        .brechas-panel {
            background: var(--color-blanco);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .brechas-panel h2 {
            font-size: 20px;
            color: var(--color-primario);
            margin-bottom: 20px;
        }
        
        .brechas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .brecha-card {
            border: 2px solid var(--color-gris-claro);
            border-radius: 8px;
            padding: 20px;
        }
        
        .brecha-card h3 {
            font-size: 16px;
            color: var(--color-acento2);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .brecha-lista {
            list-style: none;
        }
        
        .brecha-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--color-gris-claro);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .brecha-item:last-child {
            border-bottom: none;
        }
        
        .brecha-nombre {
            font-size: 14px;
            color: var(--color-texto);
        }
        
        .brecha-valor {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-acento2);
        }
        
        /* === MEJORA 6: FILTROS GUARDADOS === */
        .perfiles-panel {
            background: linear-gradient(135deg, #00897b, #00695c);
            color: var(--color-blanco);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .perfiles-panel h2 {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .perfiles-acciones {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .perfil-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            font-size: 14px;
            background-color: rgba(255,255,255,0.9);
        }
        
        .perfiles-lista {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .perfil-item {
            background-color: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .perfil-item:hover {
            background-color: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }
        
        .perfil-nombre {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .perfil-eliminar {
            background-color: var(--color-peligro);
            color: var(--color-blanco);
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .perfil-eliminar:hover {
            background-color: #c62828;
        }
        
        /* === MEJORA 7: M√âTRICAS DE EFICIENCIA === */
        .eficiencia-panel {
            background: var(--color-blanco);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .eficiencia-panel h2 {
            font-size: 20px;
            color: var(--color-primario);
            margin-bottom: 20px;
        }
        
        .eficiencia-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .eficiencia-card {
            background: linear-gradient(135deg, var(--color-fondo), var(--color-gris-claro));
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--color-secundario);
        }
        
        .eficiencia-valor {
            font-size: 36px;
            font-weight: 700;
            color: var(--color-secundario);
            margin-bottom: 5px;
        }
        
        .eficiencia-label {
            font-size: 13px;
            color: var(--color-gris);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .eficiencia-descripcion {
            font-size: 11px;
            color: var(--color-gris);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--color-gris-claro);
        }
        
        /* === MEJORA 8: MODO PRESENTACI√ìN === */
        .modo-presentacion {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            z-index: 10000;
            display: none;
            overflow: hidden;
        }
        
        .modo-presentacion.active {
            display: block;
        }
        
        .presentacion-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .presentacion-slide.active {
            opacity: 1;
        }
        
        .presentacion-titulo {
            font-size: 48px;
            font-weight: 700;
            color: var(--color-blanco);
            text-align: center;
            margin-bottom: 40px;
        }
        
        .presentacion-contenido {
            width: 100%;
            max-width: 1200px;
            background-color: rgba(255,255,255,0.05);
            padding: 40px;
            border-radius: 12px;
        }
        
        .presentacion-kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }
        
        .presentacion-kpi {
            text-align: center;
            padding: 30px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .presentacion-kpi-valor {
            font-size: 72px;
            font-weight: 700;
            color: var(--color-primario);
            margin-bottom: 10px;
        }
        
        .presentacion-kpi-label {
            font-size: 20px;
            color: var(--color-blanco);
            text-transform: uppercase;
        }
        
        .presentacion-controles {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background-color: rgba(0,0,0,0.8);
            padding: 15px 25px;
            border-radius: 50px;
        }
        
        .presentacion-btn {
            background-color: var(--color-blanco);
            color: var(--color-texto);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .presentacion-btn:hover {
            background-color: var(--color-primario);
            color: var(--color-blanco);
        }
        
        .presentacion-indicador {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--color-blanco);
            font-size: 14px;
        }
        
        /* === MEJORA 9: AN√ÅLISIS PREDICTIVO === */
        .predictivo-panel {
            background: linear-gradient(135deg, #5e35b1, #4527a0);
            color: var(--color-blanco);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .predictivo-panel h2 {
            font-size: 20px;
            margin-bottom: 20px;
        }
        
        .predictivo-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .predictivo-card {
            background-color: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 6px;
        }
        
        .predictivo-periodo {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .predictivo-valor {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .predictivo-label {
            font-size: 13px;
            opacity: 0.8;
        }
        
        .predictivo-tendencia {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tendencia-positiva {
            color: #4caf50;
        }
        
        .tendencia-negativa {
            color: #f44336;
        }
        
        .tendencia-estable {
            color: #ffc107;
        }
        
        .predictivo-grafico {
            margin-top: 20px;
            background-color: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 6px;
        }
        
        /* === MEJORA 10: EXPORTACI√ìN DE GR√ÅFICOS === */
        .grafico-export-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--color-primario);
            color: var(--color-blanco);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .grafico-card:hover .grafico-export-btn {
            opacity: 1;
        }
        
        .grafico-export-btn:hover {
            background-color: var(--color-secundario);
        }
        
        .grafico-card {
            position: relative;
        }
        
        /* ======================================== */
        /* üÜï NUEVAS MEJORAS v4.0 (11-15) */
        /* ======================================== */
        
        /* üÜï MEJORA 11: AN√ÅLISIS DE CORRELACIONES */
        .correlaciones-panel {
            background: linear-gradient(135deg, #e91e63, #c2185b);
            color: var(--color-blanco);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .correlaciones-panel h2 {
            font-size: 22px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .correlaciones-panel p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .matriz-correlacion {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .correlacion-item {
            background-color: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .correlacion-item:hover {
            background-color: rgba(255,255,255,0.25);
            transform: scale(1.05);
        }
        
        .correlacion-valor {
            font-size: 42px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .correlacion-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .correlacion-interpretacion {
            font-size: 12px;
            opacity: 0.85;
            margin-top: 8px;
            font-style: italic;
        }
        
        .correlacion-positiva { color: #4caf50; }
        .correlacion-negativa { color: #ff5252; }
        .correlacion-neutra { color: #ffc107; }
        
        /* üÜï MEJORA 12: BENCHMARK Y PERCENTILES */
        .benchmark-panel {
            background: linear-gradient(135deg, #673ab7, #512da8);
            color: var(--color-blanco);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .benchmark-panel h2 {
            font-size: 22px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .benchmark-panel p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .percentiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .percentil-categoria {
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 20px;
        }
        
        .percentil-categoria h4 {
            font-size: 16px;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        
        .percentil-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .percentil-excelente {
            background: linear-gradient(90deg, rgba(76,175,80,0.3), transparent);
            border-left: 4px solid #4caf50;
        }
        
        .percentil-bueno {
            background: linear-gradient(90deg, rgba(33,150,243,0.3), transparent);
            border-left: 4px solid #2196f3;
        }
        
        .percentil-regular {
            background: linear-gradient(90deg, rgba(255,193,7,0.3), transparent);
            border-left: 4px solid #ffc107;
        }
        
        .percentil-mejorar {
            background: linear-gradient(90deg, rgba(244,67,54,0.3), transparent);
            border-left: 4px solid #f44336;
        }
        
        .percentil-nombre {
            font-size: 14px;
            flex: 1;
        }
        
        .percentil-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin: 0 10px;
        }
        
        .percentil-valor {
            font-size: 16px;
            font-weight: 700;
        }
        
        /* üÜï MEJORA 13: EXPORTACI√ìN PDF */
        .pdf-panel {
            background: linear-gradient(135deg, #ff6f00, #e65100);
            color: var(--color-blanco);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .pdf-panel h2 {
            font-size: 22px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pdf-panel p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .pdf-opciones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .pdf-opcion {
            background-color: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .pdf-opcion:hover {
            background-color: rgba(255,255,255,0.25);
            transform: translateY(-5px);
        }
        
        .pdf-opcion-icono {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .pdf-opcion-titulo {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .pdf-opcion-desc {
            font-size: 13px;
            opacity: 0.9;
        }
        
        /* üÜï MEJORA 14: MODO COMPARACI√ìN */
        .comparacion-panel {
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            color: var(--color-blanco);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .comparacion-panel h2 {
            font-size: 22px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .comparacion-panel p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .comparacion-selectores {
            display: grid;
            grid-template-columns: 1fr 80px 1fr;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .comparacion-selector {
            background-color: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
        }
        
        .comparacion-selector label {
            display: block;
            font-size: 12px;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .comparacion-selector select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            background-color: rgba(255,255,255,0.9);
        }
        
        .comparacion-vs {
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: rgba(255,255,255,0.8);
        }
        
        .comparacion-resultados {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 25px;
        }
        
        .comparacion-entidad {
            background-color: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 8px;
        }
        
        .comparacion-entidad-nombre {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        
        .comparacion-metrica {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .comparacion-metrica-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .comparacion-metrica-valor {
            font-size: 16px;
            font-weight: 700;
        }
        
        .comparacion-ganador {
            background: linear-gradient(90deg, rgba(255,215,0,0.3), transparent);
            border-left: 4px solid #ffd700;
            padding-left: 10px;
        }
        
        /* üÜï MEJORA 15: B√öSQUEDA AVANZADA */
        .busqueda-avanzada-panel {
            background-color: var(--color-blanco);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
        }
        
        .busqueda-avanzada-panel h2 {
            font-size: 20px;
            color: var(--color-primario);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .busqueda-avanzada-panel > p {
            font-size: 14px;
            color: var(--color-gris);
            margin-bottom: 15px;
        }
        
        .busqueda-avanzada-controles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .busqueda-campo {
            display: flex;
            flex-direction: column;
        }
        
        .busqueda-campo label {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-gris);
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .busqueda-campo input,
        .busqueda-campo select {
            padding: 10px;
            border: 1px solid var(--color-gris-claro);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .busqueda-campo input:focus,
        .busqueda-campo select:focus {
            outline: none;
            border-color: var(--color-primario);
        }
        
        .busqueda-resultados-info {
            background-color: var(--color-gris-claro);
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .busqueda-resultados-contador {
            font-weight: 600;
            color: var(--color-primario);
        }
        
        .busqueda-limpiar {
            background-color: var(--color-peligro);
            color: var(--color-blanco);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        
        .busqueda-limpiar:hover {
            background-color: #c62828;
        }
        
        /* Ajustes responsivos para nuevos paneles */
        @media (max-width: 768px) {
            .comparacion-selectores {
                grid-template-columns: 1fr;
            }
            
            .comparacion-vs {
                font-size: 24px;
            }
            
            .comparacion-resultados {
                grid-template-columns: 1fr;
            }
            
            .percentiles-grid {
                grid-template-columns: 1fr;
            }
            
            .matriz-correlacion {
                grid-template-columns: 1fr;
            }
            
            /* Footer responsive */
            footer {
                padding: 20px 15px !important;
            }
            
            footer h3 {
                font-size: 18px !important;
            }
            
            footer div[style*="flex-wrap"] {
                font-size: 11px !important;
            }
        }
    </style>
</head>
<body>
    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- MEJORA 8: MODO PRESENTACI√ìN -->
    <div id="modo-presentacion" class="modo-presentacion">
        <div class="presentacion-slide active" id="slide-1">
            <div class="presentacion-titulo">üìä Registro de Actuaciones de Promoci√≥n de la Salud</div>
            <div class="presentacion-contenido">
                <div class="presentacion-kpis" id="presentacion-kpis-slide1"></div>
            </div>
        </div>
        
        <div class="presentacion-slide" id="slide-2">
            <div class="presentacion-titulo">üìà Distribuci√≥n por Tipo de Actividad</div>
            <div class="presentacion-contenido" style="height: 600px;">
                <canvas id="presentacion-grafico-tipos"></canvas>
            </div>
        </div>
        
        <div class="presentacion-slide" id="slide-3">
            <div class="presentacion-titulo">üìö Distribuci√≥n por Tem√°tica</div>
            <div class="presentacion-contenido" style="height: 600px;">
                <canvas id="presentacion-grafico-tematicas"></canvas>
            </div>
        </div>
        
        <div class="presentacion-slide" id="slide-4">
            <div class="presentacion-titulo">üë• Participaci√≥n por Sexo</div>
            <div class="presentacion-contenido">
                <div class="presentacion-kpis" id="presentacion-kpis-slide4"></div>
            </div>
        </div>
        
        <div class="presentacion-controles">
            <button class="presentacion-btn" id="btn-prev-slide">‚óÄ Anterior</button>
            <button class="presentacion-btn" id="btn-play-pause">‚ñ∂ Auto</button>
            <button class="presentacion-btn" id="btn-next-slide">Siguiente ‚ñ∂</button>
            <button class="presentacion-btn" id="btn-salir-presentacion">‚úï Salir</button>
        </div>
        
        <div class="presentacion-indicador" id="presentacion-indicador">1 / 4</div>
    </div>
    
    <!-- HEADER -->
    <header>
        <h1>üìä Registro de actuaciones de promoci√≥n de la salud</h1>
        <p>Distrito Sanitario Granada-Metropolitano | An√°lisis por Distrito, Unidad y Profesional | v4.0 üöÄ</p>
        <div class="header-actions">
            <input type="file" id="file-input" accept=".csv" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('file-input').click();">
                üìÅ Cargar archivo CSV
            </button>
            <button class="btn btn-secondary" id="btn-limpiar-datos" style="background-color: #f44336; color: white;">
                üóëÔ∏è Limpiar datos
            </button>
            <button class="btn btn-secondary" id="btn-exportar-csv">
                üíæ Exportar datos filtrados (CSV)
            </button>
            <button class="btn btn-success" id="btn-exportar-excel">
                üìä Exportar Excel Profesional
            </button>
            <button class="btn btn-secondary" id="btn-modo-presentacion">
                üìΩÔ∏è Modo Presentaci√≥n
            </button>
            <button class="btn btn-secondary" style="background-color: #ff6f00; color: white;" onclick="accionRapidaPDF();">
                üìÑ Generar informe PDF
            </button>
        </div>
    </header>
    
    <!-- CONTENIDO PRINCIPAL -->
    <div class="container">
        
        <!-- SISTEMA DE ALERTAS -->
        <div class="alertas-panel" id="alertas-panel" style="display: none;">
            <h2>‚ö†Ô∏è Alertas del Sistema</h2>
            <div id="alertas-container"></div>
        </div>
        
        <!-- COMPARATIVAS TEMPORALES -->
        <div class="comparativas-panel" id="comparativas-panel" style="display: none;">
            <h2>üìà Comparativas Temporales</h2>
            <div class="periodo-selector">
                <div class="periodo-grupo">
                    <label>Per√≠odo actual:</label>
                    <select id="periodo-actual">
                        <option value="mes-actual">Mes actual</option>
                        <option value="trimestre-actual" selected>Trimestre actual</option>
                        <option value="a√±o-actual">A√±o actual</option>
                    </select>
                </div>
                <div class="periodo-grupo">
                    <label>Comparar con:</label>
                    <select id="periodo-comparar">
                        <option value="anterior" selected>Per√≠odo anterior</option>
                        <option value="a√±o-anterior">Mismo per√≠odo a√±o anterior</option>
                    </select>
                </div>
                <div class="periodo-grupo">
                    <button class="btn btn-primary" id="btn-actualizar-comparativa">Actualizar comparativa</button>
                </div>
            </div>
            <div class="comparativa-cards" id="comparativa-cards"></div>
        </div>
        
        <!-- DASHBOARD PROFESIONAL INDIVIDUAL -->
        <div class="dashboard-profesional" id="dashboard-profesional" style="display: none;">
            <h2>üë§ Mi Dashboard Personal</h2>
            <p id="profesional-nombre"></p>
            <div class="profesional-info" id="profesional-info"></div>
            
            <!-- Bot√≥n para generar informe exhaustivo -->
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #1976d2, #2196f3); border-radius: 8px; text-align: center;">
                <button onclick="generarInformeProfesionalExhaustivo()" style="background: white; color: #1976d2; border: none; padding: 12px 30px; font-size: 16px; font-weight: bold; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                    üìÑ GENERAR MI INFORME PROFESIONAL COMPLETO
                </button>
                <p style="color: white; margin: 10px 0 0 0; font-size: 13px;">
                    Documento exhaustivo con todas tus actividades y evidencias para justificar objetivos
                </p>
            </div>
        </div>
        
        <!-- AN√ÅLISIS DE BRECHAS -->
        <div class="brechas-panel" id="brechas-panel" style="display: none;">
            <h2>üéØ An√°lisis de Brechas y Oportunidades</h2>
            <div class="brechas-grid" id="brechas-grid"></div>
        </div>
        
        <!-- MEJORA 6: FILTROS GUARDADOS / PERFILES -->
        <div class="perfiles-panel" id="perfiles-panel" style="display: none;">
            <h2>‚≠ê Mis Perfiles Guardados</h2>
            <div class="perfiles-acciones">
                <input type="text" id="perfil-nombre-input" class="perfil-input" placeholder="Nombre del perfil (ej: Mi unidad - √öltimo trimestre)">
                <button class="btn btn-primary" id="btn-guardar-perfil">üíæ Guardar filtros actuales</button>
            </div>
            <div class="perfiles-lista" id="perfiles-lista"></div>
        </div>
        
        <!-- MEJORA 7: M√âTRICAS DE EFICIENCIA -->
        <div class="eficiencia-panel" id="eficiencia-panel" style="display: none;">
            <h2>‚ö° M√©tricas de Eficiencia</h2>
            <div class="eficiencia-grid" id="eficiencia-grid"></div>
        </div>
        
        <!-- MEJORA 9: AN√ÅLISIS PREDICTIVO -->
        <div class="predictivo-panel" id="predictivo-panel" style="display: none;">
            <h2>üîÆ Proyecciones y Tendencias</h2>
            <div class="predictivo-cards" id="predictivo-cards"></div>
            <div class="predictivo-grafico">
                <canvas id="grafico-predictivo"></canvas>
            </div>
        </div>
        
        <!-- ======================================== -->
        <!-- üÜï NUEVOS PANELES v4.0 (MEJORAS 11-15) -->
        <!-- ======================================== -->
        
        <!-- üÜï MEJORA 11: AN√ÅLISIS DE CORRELACIONES -->
        <div class="correlaciones-panel" id="correlaciones-panel" style="display: none;">
            <h2>üîó An√°lisis de Correlaciones</h2>
            <p>An√°lisis de relaciones entre diferentes m√©tricas del sistema</p>
            <div class="matriz-correlacion" id="correlaciones-grid"></div>
        </div>
        
        <!-- üÜï MEJORA 12: BENCHMARK Y PERCENTILES -->
        <div class="benchmark-panel" id="benchmark-panel" style="display: none;">
            <h2>üìè Benchmark y Clasificaci√≥n por Percentiles</h2>
            <p>Clasificaci√≥n de unidades y profesionales seg√∫n su rendimiento comparativo</p>
            <div class="percentiles-grid" id="percentiles-grid"></div>
        </div>
        
        <!-- üÜï MEJORA 13: EXPORTACI√ìN PDF -->
        <div class="pdf-panel" id="pdf-panel" style="display: none;">
            <h2>üìÑ Generador de Informes PDF</h2>
            <p>Exporta informes profesionales en formato PDF con gr√°ficos y an√°lisis</p>
            <div class="pdf-opciones">
                <div class="pdf-opcion" onclick="generarPDFEjecutivo()">
                    <div class="pdf-opcion-icono">üìä</div>
                    <div class="pdf-opcion-titulo">Resumen Ejecutivo</div>
                    <div class="pdf-opcion-desc">KPIs principales y m√©tricas clave</div>
                </div>
                <div class="pdf-opcion" onclick="generarPDFCompleto()">
                    <div class="pdf-opcion-icono">üìà</div>
                    <div class="pdf-opcion-titulo">Informe Completo</div>
                    <div class="pdf-opcion-desc">An√°lisis detallado con todos los gr√°ficos</div>
                </div>
                <div class="pdf-opcion" onclick="generarPDFComparativo()">
                    <div class="pdf-opcion-icono">‚öñÔ∏è</div>
                    <div class="pdf-opcion-titulo">An√°lisis Comparativo</div>
                    <div class="pdf-opcion-desc">Comparaci√≥n entre distritos y unidades</div>
                </div>
                <div class="pdf-opcion" onclick="generarPDFPersonalizado()">
                    <div class="pdf-opcion-icono">‚öôÔ∏è</div>
                    <div class="pdf-opcion-titulo">Personalizado</div>
                    <div class="pdf-opcion-desc">Selecciona los elementos a incluir</div>
                </div>
            </div>
        </div>
        
        <!-- üÜï MEJORA 14: MODO COMPARACI√ìN -->
        <div class="comparacion-panel" id="comparacion-panel" style="display: none;">
            <h2>‚öñÔ∏è Modo Comparaci√≥n Directa</h2>
            <p>Compara dos entidades (unidades o profesionales) lado a lado</p>
            <div class="comparacion-selectores">
                <div class="comparacion-selector">
                    <label>Entidad 1:</label>
                    <select id="comparacion-entidad1" onchange="actualizarComparacion()">
                        <option value="">-- Seleccionar --</option>
                    </select>
                </div>
                <div class="comparacion-vs">VS</div>
                <div class="comparacion-selector">
                    <label>Entidad 2:</label>
                    <select id="comparacion-entidad2" onchange="actualizarComparacion()">
                        <option value="">-- Seleccionar --</option>
                    </select>
                </div>
            </div>
            <div class="comparacion-resultados" id="comparacion-resultados"></div>
        </div>
        
        <!-- üÜï MEJORA 15: B√öSQUEDA AVANZADA -->
        <div class="busqueda-avanzada-panel" id="busqueda-panel" style="display: none;">
            <h2>üîé B√∫squeda Avanzada en Datos</h2>
            <p>Aplica m√∫ltiples criterios de b√∫squeda simult√°neamente</p>
            <div class="busqueda-avanzada-controles">
                <div class="busqueda-campo">
                    <label>Profesional:</label>
                    <input type="text" id="busqueda-profesional" placeholder="Nombre del profesional...">
                </div>
                <div class="busqueda-campo">
                    <label>Actividad:</label>
                    <input type="text" id="busqueda-actividad" placeholder="Nombre de actividad...">
                </div>
                <div class="busqueda-campo">
                    <label>Tem√°tica:</label>
                    <select id="busqueda-tematica">
                        <option value="">-- Todas --</option>
                    </select>
                </div>
                <div class="busqueda-campo">
                    <label>Tipo:</label>
                    <select id="busqueda-tipo">
                        <option value="">-- Todos --</option>
                    </select>
                </div>
                <div class="busqueda-campo">
                    <label>Participantes m√≠nimos:</label>
                    <input type="number" id="busqueda-min-participantes" placeholder="0">
                </div>
                <div class="busqueda-campo">
                    <label>Zona desfavorecida:</label>
                    <select id="busqueda-zona">
                        <option value="">-- Todas --</option>
                        <option value="1">S√≠</option>
                        <option value="0">No</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="aplicarBusquedaAvanzada()">üîç Buscar</button>
                <button class="btn btn-secondary" onclick="limpiarBusquedaAvanzada()">üîÑ Limpiar</button>
            </div>
            <div class="busqueda-resultados-info" id="busqueda-info" style="display: none;">
                <span class="busqueda-resultados-contador" id="busqueda-contador"></span>
                <button class="busqueda-limpiar" onclick="limpiarBusquedaAvanzada()">‚úï Cerrar b√∫squeda</button>
            </div>
        </div>
        
        <!-- PANEL DE NIVEL DE AN√ÅLISIS -->
        <div class="nivel-panel">
            <h2>üéØ Seleccionar Nivel de An√°lisis</h2>
            <div class="nivel-selector">
                <div class="nivel-grupo">
                    <label>Nivel de agregaci√≥n:</label>
                    <select id="nivel-agregacion">
                        <option value="global">üåç Distrito Sanitario Granada-Metropolitano (Total)</option>
                        <option value="distrito-granada">üìç Distrito Granada</option>
                        <option value="distrito-metro">üìç Distrito Metropolitano de Granada</option>
                        <option value="unidad">üè• Por Unidad Asistencial</option>
                        <option value="profesional">üë§ Por Profesional</option>
                    </select>
                </div>
                
                <div class="nivel-grupo" id="grupo-unidad" style="display: none;">
                    <label>Seleccionar Unidad:</label>
                    <select id="select-unidad">
                        <option value="">-- Todas las unidades --</option>
                    </select>
                </div>
                
                <div class="nivel-grupo" id="grupo-profesional" style="display: none;">
                    <label>Seleccionar Profesional:</label>
                    <select id="select-profesional">
                        <option value="">-- Todos los profesionales --</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- NIVEL ACTUAL -->
        <div class="nivel-actual" id="nivel-actual-info">
            <h3>üìå Nivel de an√°lisis actual:</h3>
            <p class="info" id="nivel-actual-texto">Distrito Sanitario Granada-Metropolitano (Total)</p>
        </div>
        
        <!-- PANEL DE FILTROS -->
        <div class="filtros-panel">
            <h2>üîç Filtros avanzados</h2>
            <div class="filtros-grid">
                <div class="filtro-grupo">
                    <label>Fecha desde:</label>
                    <input type="date" id="filtro-fecha-desde">
                </div>
                <div class="filtro-grupo">
                    <label>Fecha hasta:</label>
                    <input type="date" id="filtro-fecha-hasta">
                </div>
                <div class="filtro-grupo">
                    <label>Tipo de actividad:</label>
                    <select id="filtro-tipo-actividad">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filtro-grupo">
                    <label>Tem√°tica:</label>
                    <select id="filtro-tematica">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filtro-grupo">
                    <label>Programa:</label>
                    <select id="filtro-programa">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" id="btn-aplicar-filtros">Aplicar filtros</button>
            <button class="btn btn-secondary" id="btn-limpiar-filtros">Limpiar filtros</button>
        </div>
        
        <!-- KPIs PRINCIPALES -->
        <div class="kpis-grid" id="kpis-container">
            <div class="kpi-card">
                <div class="icono">üìã</div>
                <div class="valor" id="kpi-actividades">0</div>
                <div class="etiqueta">Actividades</div>
            </div>
            <div class="kpi-card">
                <div class="icono">üë•</div>
                <div class="valor" id="kpi-participantes">0</div>
                <div class="etiqueta">Participantes</div>
            </div>
            <div class="kpi-card">
                <div class="icono">‚è±Ô∏è</div>
                <div class="valor" id="kpi-horas">0</div>
                <div class="etiqueta">Horas totales</div>
            </div>
            <div class="kpi-card">
                <div class="icono">üéØ</div>
                <div class="valor" id="kpi-sesiones">0</div>
                <div class="etiqueta">Sesiones</div>
            </div>
            <div class="kpi-card">
                <div class="icono">‚ôÇÔ∏è</div>
                <div class="valor" id="kpi-hombres">0</div>
                <div class="etiqueta">Hombres</div>
                <div class="subtexto" id="kpi-hombres-pct">0%</div>
            </div>
            <div class="kpi-card">
                <div class="icono">‚ôÄÔ∏è</div>
                <div class="valor" id="kpi-mujeres">0</div>
                <div class="etiqueta">Mujeres</div>
                <div class="subtexto" id="kpi-mujeres-pct">0%</div>
            </div>
        </div>
        
        <!-- RANKINGS (solo visible en ciertos niveles) -->
        <div id="rankings-container" style="display: none;">
            <div class="graficos-grid">
                <div class="ranking-card">
                    <h3 id="ranking-titulo-1">üèÜ Top 10 Unidades por Actividades</h3>
                    <div id="ranking-1"></div>
                </div>
                <div class="ranking-card">
                    <h3 id="ranking-titulo-2">üë• Top 10 Profesionales por Participantes</h3>
                    <div id="ranking-2"></div>
                </div>
            </div>
        </div>
        
        <!-- GR√ÅFICOS -->
        <div class="graficos-grid">
            <div class="grafico-card">
                <button class="grafico-export-btn" data-chart="grafico-tipos">üì• Descargar PNG</button>
                <h3>üìä Actividades por tipo</h3>
                <div class="grafico-container">
                    <canvas id="grafico-tipos"></canvas>
                </div>
            </div>
            <div class="grafico-card">
                <button class="grafico-export-btn" data-chart="grafico-tematicas">üì• Descargar PNG</button>
                <h3>üìö Actividades por tem√°tica</h3>
                <div class="grafico-container">
                    <canvas id="grafico-tematicas"></canvas>
                </div>
            </div>
            <div class="grafico-card">
                <button class="grafico-export-btn" data-chart="grafico-programas">üì• Descargar PNG</button>
                <h3>üéØ Distribuci√≥n por programa</h3>
                <div class="grafico-container">
                    <canvas id="grafico-programas"></canvas>
                </div>
            </div>
            <div class="grafico-card">
                <button class="grafico-export-btn" data-chart="grafico-genero">üì• Descargar PNG</button>
                <h3>üë• Participantes por sexo</h3>
                <div class="grafico-container">
                    <canvas id="grafico-genero"></canvas>
                </div>
            </div>
        </div>
        
        <div class="graficos-grid">
            <div class="grafico-card">
                <button class="grafico-export-btn" data-chart="grafico-distritos">üì• Descargar PNG</button>
                <h3 id="titulo-grafico-comparativo">üìä Comparativa por Distrito</h3>
                <div class="grafico-container">
                    <canvas id="grafico-distritos"></canvas>
                </div>
            </div>
            <div class="grafico-card">
                <button class="grafico-export-btn" data-chart="grafico-mensual">üì• Descargar PNG</button>
                <h3>üìà Evoluci√≥n mensual</h3>
                <div class="grafico-container">
                    <canvas id="grafico-mensual"></canvas>
                </div>
            </div>
        </div>
        
        <!-- TABLA DE DATOS CON PESTA√ëAS -->
        <div class="tabla-container">
            <div class="tabla-header">
                <h3>üìã Detalle de actividades</h3>
                <input type="text" id="busqueda-tabla" class="busqueda-input" placeholder="Buscar por actividad o profesional...">
            </div>
            
            <!-- Pesta√±as -->
            <div class="tabs-container">
                <div class="tab active" data-tab="granada">üìç Distrito Granada</div>
                <div class="tab" data-tab="metro">üìç Distrito Metropolitano</div>
                <div class="tab" data-tab="ambos">üåç Distrito Granada-Metropolitano</div>
            </div>
            
            <!-- Contenido de las pesta√±as -->
            <div class="tab-content active" id="tab-granada">
                <table>
                    <thead>
                        <tr>
                            <th>Unidad</th>
                            <th>Profesional</th>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Actividad</th>
                            <th>Participantes</th>
                            <th>Horas</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body-granada">
                    </tbody>
                </table>
                <div class="paginacion-container">
                    <div class="paginacion-info" id="paginacion-granada"></div>
                    <div class="paginacion-botones">
                        <button class="btn btn-secondary" id="btn-anterior-granada">‚Üê Anterior</button>
                        <button class="btn btn-secondary" id="btn-siguiente-granada">Siguiente ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="tab-metro">
                <table>
                    <thead>
                        <tr>
                            <th>Unidad</th>
                            <th>Profesional</th>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Actividad</th>
                            <th>Participantes</th>
                            <th>Horas</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body-metro">
                    </tbody>
                </table>
                <div class="paginacion-container">
                    <div class="paginacion-info" id="paginacion-metro"></div>
                    <div class="paginacion-botones">
                        <button class="btn btn-secondary" id="btn-anterior-metro">‚Üê Anterior</button>
                        <button class="btn btn-secondary" id="btn-siguiente-metro">Siguiente ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="tab-ambos">
                <table>
                    <thead>
                        <tr>
                            <th>Distrito</th>
                            <th>Unidad</th>
                            <th>Profesional</th>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Actividad</th>
                            <th>Participantes</th>
                            <th>Horas</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body-ambos">
                    </tbody>
                </table>
                <div class="paginacion-container">
                    <div class="paginacion-info" id="paginacion-ambos"></div>
                    <div class="paginacion-botones">
                        <button class="btn btn-secondary" id="btn-anterior-ambos">‚Üê Anterior</button>
                        <button class="btn btn-secondary" id="btn-siguiente-ambos">Siguiente ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- FOOTER CON INFORMACI√ìN DE LICENCIA -->
    <footer style="background: linear-gradient(135deg, #37474f, #263238); color: white; padding: 30px; margin-top: 40px; text-align: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 20px; margin-bottom: 10px; font-weight: 600;">üìä RAPS_DGRAMET v4.0</h3>
                <p style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Registro de Actuaciones de Promoci√≥n de la Salud</p>
                <p style="font-size: 13px; opacity: 0.85; margin-bottom: 5px;">Distrito Sanitario Granada-Metropolitano</p>
                <p style="font-size: 12px; opacity: 0.8;">√öltima actualizaci√≥n: Octubre 2025</p>
            </div>
            
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; margin: 20px 0; text-align: left; max-width: 800px; margin-left: auto; margin-right: auto;">
                <h4 style="font-size: 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">‚öñÔ∏è</span> Licencia MIT
                </h4>
                <p style="font-size: 13px; line-height: 1.8; opacity: 0.95; margin-bottom: 10px;">
                    <strong>Software:</strong> Copyright ¬© 2025 BR Hermoso
                </p>
                <p style="font-size: 12px; line-height: 1.7; opacity: 0.9; margin-bottom: 12px;">
                    Este software se proporciona bajo la <strong>Licencia MIT</strong>. Se concede permiso gratuito a cualquier persona 
                    que obtenga una copia de este software para usar, copiar, modificar, fusionar, publicar, distribuir, sublicenciar 
                    y/o vender copias del software, sujeto a las condiciones de la licencia MIT completa.
                </p>
                <p style="font-size: 11px; line-height: 1.6; opacity: 0.85; margin-bottom: 12px; font-style: italic;">
                    EL SOFTWARE SE PROPORCIONA "TAL CUAL", SIN GARANT√çA DE NING√öN TIPO, EXPRESA O IMPL√çCITA.
                </p>
                <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px; margin-top: 12px;">
                    <p style="font-size: 11px; line-height: 1.6; opacity: 0.85;">
                        <strong>NOTA SOBRE LOS DATOS:</strong> Los datos de actuaciones, profesionales y unidades asistenciales 
                        procesados por este software son propiedad del Distrito Sanitario Granada-Metropolitano del Servicio Andaluz 
                        de Salud. El c√≥digo del software est√° licenciado bajo MIT, pero los datos utilizados est√°n sujetos a las 
                        pol√≠ticas de protecci√≥n de datos y propiedad del distrito sanitario correspondiente.
                    </p>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                <p style="font-size: 13px; opacity: 0.9; margin-bottom: 10px;">
                    <strong>‚ú® Caracter√≠sticas principales:</strong>
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; font-size: 12px; opacity: 0.85;">
                    <span>üìä An√°lisis avanzado de datos</span>
                    <span>üìà Visualizaci√≥n interactiva</span>
                    <span>üîç Filtrado m√∫ltiple</span>
                    <span>üìÅ Exportaci√≥n Excel/PDF</span>
                    <span>üéØ An√°lisis por niveles</span>
                    <span>üîÑ Comparativas y correlaciones</span>
                </div>
            </div>
            
            <div style="margin-top: 25px; font-size: 12px; opacity: 0.8;">
                <p>Desarrollado con ‚ù§Ô∏è para la promoci√≥n de la salud</p>
                <p style="margin-top: 5px;">HTML5 + JavaScript + Chart.js + PapaParse + XLSX + jsPDF</p>
            </div>
        </div>
    </footer>
    
    <!-- JAVASCRIPT -->
    <script>
        // ===========================
        // CONFIGURACI√ìN GLOBAL
        // ===========================
        const CONFIG = {
            campos: {
                fecha_inicio: 'fecha_de_inicio',
                nombre_actividad: 'nombre_de_la_actividad',
                tipo_actividad: 'tipo_de_actividad',
                tematica: 'qu_tem_tica_s_aborda_la_ac',
                programa: 'en_qu_estrategia_plan_inte',
                participantes: 'asist_total',
                hombres: 'asist_hombres',
                mujeres: 'asist_mujeres',
                horas: 'n_mero_de_horas',
                sesiones: 'n_mero_de_sesiones',
                profesional: 'apellidos_y_nombre',
                distrito: 'distrito0',
                unidad_granada: 'unidad_asistencial',
                unidad_metro: 'unidad_asistencial_2',
                unidad_nombre: 'unidad_nombre_referencia'
            },
            tipos_actividad: {
                '0': 'Charla',
                '1': 'Comisi√≥n/grupo trabajo',
                '2': 'Control Alerta Salud P√∫blica',
                '3': 'Entrevista/Reuni√≥n',
                '4': 'Intervenci√≥n en medios',
                '5': 'Intervenci√≥n grupal: personas cuidadoras',
                '6': 'Intervenci√≥n grupal: dolor',
                '7': 'Intervenci√≥n grupal: educaci√≥n diabetol√≥gica',
                '8': 'Intervenci√≥n grupal: EPOC/asma',
                '9': 'Intervenci√≥n grupal: rehabilitaci√≥n cardiaca',
                '10': 'Intervenci√≥n grupal: rehabilitaci√≥n respiratoria',
                '11': 'Educaci√≥n maternal',
                '12': 'GRAFA',
                '13': 'GRUSE',
                '14': 'IAHS',
                '15': 'PIOBIN',
                '16': 'PITA',
                '17': 'PSIA',
                '18': 'Mapeo activos',
                '19': 'Mesa informativa/stand',
                '20': 'Ponencia/comunicaci√≥n',
                '21': 'Sesi√≥n cl√≠nica',
                '22': 'Sesi√≥n formativa',
                '23': 'Taller',
                '24': 'Otros'
            },
            tematicas: {
                '1': 'Actividad f√≠sica',
                '2': 'Activos para la salud',
                '3': 'Alimentaci√≥n saludable',
                '4': 'Bienestar emocional',
                '5': 'Conducta suicida',
                '6': 'Consumo de alcohol',
                '7': 'Consumo de tabaco',
                '8': 'Dolor',
                '9': 'Enfermedades transmisibles',
                '10': 'Envejecimiento saludable',
                '11': 'Higiene de manos',
                '12': 'Higiene postural',
                '13': 'Incontinencia urinaria',
                '14': 'Infecciones relacionadas con atenci√≥n sanitaria',
                '15': 'Lactancia materna',
                '16': 'Manejo terap√©utico enfermedad',
                '17': 'Menopausia',
                '18': 'Otras adicciones',
                '19': 'Otras formas de fumar',
                '20': 'Parentalidad positiva',
                '21': 'Prevenci√≥n accidentabilidad',
                '22': 'Primeros auxilios',
                '23': 'Salud bucodental',
                '24': 'Sexualidad',
                '25': 'Uso adecuado medicamento',
                '26': 'Uso adecuado TRICs',
                '27': 'Vacunas',
                '28': 'Violencia de g√©nero',
                '29': 'Voluntades vitales y muerte digna',
                '30': 'Otra'
            },
            programas: {
                '1': 'Centros Comprometidos Violencia G√©nero',
                '2': 'En Buena Edad',
                '3': 'Escuela de Pacientes',
                '4': 'Estrategia AVISTA',
                '5': 'Estrategia de Cuidados',
                '6': 'Estrategia Seguridad Paciente',
                '7': 'Estrategia Vida Saludable (EVSA)',
                '8': 'Forma joven otros entornos',
                '9': 'GRAFA',
                '10': 'GRUSE',
                '11': 'Jornadas/Semanas de la salud',
                '12': 'Mapa Activos salud',
                '13': 'PAITSIDA',
                '14': 'PAPEF',
                '15': 'Plan Humanizaci√≥n',
                '16': 'PIOBIN',
                '17': 'PITA',
                '18': 'Plan participaci√≥n ciudadana',
                '19': 'PSIA',
                '20': 'Prevenci√≥n conducta suicida',
                '21': 'Por 1 Mill√≥n pasos',
                '22': 'PromoSalud √°mbito educativo',
                '23': 'PSLT',
                '24': 'RELAS',
                '25': 'Otros'
            },
            unidades_granada: {
                '0': 'Albayz√≠n',
                '1': 'Almanj√°yar',
                '2': 'Cartuja',
                '3': 'Caser√≠a de Montijo',
                '4': 'Caleta',
                '5': 'Chana',
                '6': 'Gran Capit√°n',
                '7': 'Flores-F√≠gares',
                '8': 'Fortuny/Velluti',
                '9': 'Zaid√≠n Centro-Este',
                '10': 'Zaid√≠n Sur',
                '11': 'G√≥gora',
                '12': 'Realejo',
                '13': 'Bola de Oro',
                '14': 'Doctores'
            },
            unidades_metro: {
                '0': 'Albolote',
                '1': 'Alfacar',
                '2': 'Alhama de Granada',
                '3': 'Armilla',
                '4': 'Atarfe',
                '5': 'Cenes de la Vega',
                '6': 'Churriana de la Vega',
                '7': 'Hu√©tor-T√°jar',
                '8': 'Hu√©tor-Vega',
                '9': '√çllora',
                '10': 'Iznalloz',
                '11': 'La Zubia',
                '12': 'Las Gabias',
                '13': 'Loja',
                '14': 'Maracena',
                '15': 'Montefr√≠o',
                '16': 'Og√≠jares',
                '17': 'Peligros',
                '18': 'Pinos Puente',
                '19': 'Santa Fe',
                '20': 'Valle de Lecr√≠n'
            },
            colores: {
                primario: '#1976d2',
                secundario: '#388e3c',
                acento1: '#f57c00',
                acento2: '#d32f2f',
                acento3: '#9c27b0',
                acento4: '#0288d1',
                paleta: ['#1976d2', '#388e3c', '#f57c00', '#d32f2f', '#9c27b0', '#0288d1', '#00796b', '#c2185b']
            }
        };
        
        // Variables globales
        let datosOriginales = [];
        let datosFiltrados = [];
        let graficos = {};
        let registrosPorPagina = 50;
        let nivelActual = 'global';
        let unidadSeleccionada = '';
        let profesionalSeleccionado = '';
        let tabActual = 'granada';
        
        // Criterios de b√∫squeda avanzada (se mantienen activos al cambiar de nivel)
        let criteriosBusquedaAvanzada = null;
        
        // Paginaci√≥n por pesta√±a
        let paginacion = {
            granada: 1,
            metro: 1,
            ambos: 1
        };
        
        // ===========================
        // CARGA DE DATOS
        // ===========================
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                mostrarLoading(true);
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        datosOriginales = results.data;
                        inicializarFiltros();
                        aplicarFiltros();
                        mostrarLoading(false);
                    },
                    error: function(error) {
                        alert('Error al cargar el archivo: ' + error.message);
                        mostrarLoading(false);
                    }
                });
            }
        });
        
        // ===========================
        // INICIALIZACI√ìN DE SELECTORES
        // ===========================
        function inicializarFiltros() {
            // Poblar selectores de filtros
            poblarSelect('filtro-tipo-actividad', CONFIG.tipos_actividad);
            poblarSelect('filtro-tematica', CONFIG.tematicas);
            poblarSelect('filtro-programa', CONFIG.programas);
            
            // Poblar selector de unidades
            const selectUnidad = document.getElementById('select-unidad');
            selectUnidad.innerHTML = '<option value="">-- Todas las unidades --</option>';
            
            // Unidades Granada
            Object.entries(CONFIG.unidades_granada).forEach(([key, value]) => {
                const option = document.createElement('option');
                option.value = `granada-${key}`;
                option.textContent = `${value} (Granada)`;
                selectUnidad.appendChild(option);
            });
            
            // Unidades Metro
            Object.entries(CONFIG.unidades_metro).forEach(([key, value]) => {
                const option = document.createElement('option');
                option.value = `metro-${key}`;
                option.textContent = `${value} (Metropolitano)`;
                selectUnidad.appendChild(option);
            });
            
            // Poblar selector de profesionales
            const profesionales = [...new Set(datosOriginales.map(row => row[CONFIG.campos.profesional]).filter(Boolean))].sort();
            const selectProfesional = document.getElementById('select-profesional');
            selectProfesional.innerHTML = '<option value="">-- Todos los profesionales --</option>';
            profesionales.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                selectProfesional.appendChild(option);
            });
        }
        
        function poblarSelect(idSelect, opciones) {
            const select = document.getElementById(idSelect);
            Object.entries(opciones).forEach(([key, value]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = value;
                select.appendChild(option);
            });
        }
        
        // ===========================
        // GESTI√ìN DE NIVEL DE AN√ÅLISIS
        // ===========================
        document.getElementById('nivel-agregacion').addEventListener('change', function(e) {
            nivelActual = e.target.value;
            
            // Mostrar/ocultar selectores seg√∫n el nivel
            document.getElementById('grupo-unidad').style.display = nivelActual === 'unidad' ? 'block' : 'none';
            document.getElementById('grupo-profesional').style.display = nivelActual === 'profesional' ? 'block' : 'none';
            
            // Si cambia el nivel, resetear selecciones espec√≠ficas
            if (nivelActual !== 'unidad') {
                document.getElementById('select-unidad').value = '';
                unidadSeleccionada = '';
            }
            if (nivelActual !== 'profesional') {
                document.getElementById('select-profesional').value = '';
                profesionalSeleccionado = '';
            }
            
            aplicarFiltros();
        });
        
        document.getElementById('select-unidad').addEventListener('change', function(e) {
            unidadSeleccionada = e.target.value;
            aplicarFiltros();
        });
        
        document.getElementById('select-profesional').addEventListener('change', function(e) {
            profesionalSeleccionado = e.target.value;
            aplicarFiltros();
        });
        
        // ===========================
        // APLICAR FILTROS
        // ===========================
        document.getElementById('btn-aplicar-filtros').addEventListener('click', aplicarFiltros);
        document.getElementById('btn-limpiar-filtros').addEventListener('click', limpiarFiltros);
        
        function aplicarFiltros() {
            datosFiltrados = datosOriginales.filter(row => {
                // Filtros de nivel
                if (nivelActual === 'distrito-granada' && String(row[CONFIG.campos.distrito]) !== '0') return false;
                if (nivelActual === 'distrito-metro' && String(row[CONFIG.campos.distrito]) !== '1') return false;
                
                if (nivelActual === 'unidad' && unidadSeleccionada) {
                    const [distrito, unidadId] = unidadSeleccionada.split('-');
                    if (distrito === 'granada') {
                        if (String(row[CONFIG.campos.distrito]) !== '0' || String(row[CONFIG.campos.unidad_granada]) !== unidadId) return false;
                    } else {
                        if (String(row[CONFIG.campos.distrito]) !== '1' || String(row[CONFIG.campos.unidad_metro]) !== unidadId) return false;
                    }
                }
                
                if (nivelActual === 'profesional' && profesionalSeleccionado) {
                    if (row[CONFIG.campos.profesional] !== profesionalSeleccionado) return false;
                }
                
                // Filtros avanzados (panel de filtros)
                const fechaDesde = document.getElementById('filtro-fecha-desde').value;
                const fechaHasta = document.getElementById('filtro-fecha-hasta').value;
                const tipoActividad = document.getElementById('filtro-tipo-actividad').value;
                const tematica = document.getElementById('filtro-tematica').value;
                const programa = document.getElementById('filtro-programa').value;
                
                if (fechaDesde) {
                    const fecha = parsearFechaREDCap(row[CONFIG.campos.fecha_inicio]);
                    if (!fecha || fecha < new Date(fechaDesde)) return false;
                }
                
                if (fechaHasta) {
                    const fecha = parsearFechaREDCap(row[CONFIG.campos.fecha_inicio]);
                    if (!fecha || fecha > new Date(fechaHasta)) return false;
                }
                
                if (tipoActividad && String(row[CONFIG.campos.tipo_actividad]) !== tipoActividad) return false;
                if (tematica && String(row[CONFIG.campos.tematica]) !== tematica) return false;
                if (programa && String(row[CONFIG.campos.programa]) !== programa) return false;
                
                // üÜï APLICAR CRITERIOS DE B√öSQUEDA AVANZADA (si existen)
                if (criteriosBusquedaAvanzada) {
                    if (criteriosBusquedaAvanzada.profesional) {
                        if (!(row[CONFIG.campos.profesional] || '').toLowerCase().includes(criteriosBusquedaAvanzada.profesional)) return false;
                    }
                    
                    if (criteriosBusquedaAvanzada.actividad) {
                        if (!(row[CONFIG.campos.nombre_actividad] || '').toLowerCase().includes(criteriosBusquedaAvanzada.actividad)) return false;
                    }
                    
                    if (criteriosBusquedaAvanzada.tematica) {
                        if (String(row[CONFIG.campos.tematica]) !== criteriosBusquedaAvanzada.tematica) return false;
                    }
                    
                    if (criteriosBusquedaAvanzada.tipo) {
                        if (String(row[CONFIG.campos.tipo_actividad]) !== criteriosBusquedaAvanzada.tipo) return false;
                    }
                    
                    if (criteriosBusquedaAvanzada.minParticipantes > 0) {
                        if ((parseInt(row[CONFIG.campos.participantes]) || 0) < criteriosBusquedaAvanzada.minParticipantes) return false;
                    }
                    
                    if (criteriosBusquedaAvanzada.zona) {
                        if (String(row['es_una_zona_desfavorecidas']) !== criteriosBusquedaAvanzada.zona) return false;
                    }
                }
                
                return true;
            });
            
            // Resetear paginaci√≥n de todas las pesta√±as
            paginacion.granada = 1;
            paginacion.metro = 1;
            paginacion.ambos = 1;
            
            // üÜï Actualizar contador de b√∫squeda si hay criterios activos
            if (criteriosBusquedaAvanzada) {
                document.getElementById('busqueda-info').style.display = 'flex';
                document.getElementById('busqueda-contador').textContent = 
                    `‚úì ${datosFiltrados.length} resultado${datosFiltrados.length !== 1 ? 's' : ''} encontrado${datosFiltrados.length !== 1 ? 's' : ''}`;
            }
            
            actualizarNivelActualInfo();
            actualizarDashboard();
        }
        
        function limpiarFiltros() {
            document.getElementById('filtro-fecha-desde').value = '';
            document.getElementById('filtro-fecha-hasta').value = '';
            document.getElementById('filtro-tipo-actividad').value = '';
            document.getElementById('filtro-tematica').value = '';
            document.getElementById('filtro-programa').value = '';
            aplicarFiltros();
        }
        
        function actualizarNivelActualInfo() {
            let texto = '';
            switch(nivelActual) {
                case 'global':
                    texto = 'üåç Distrito Sanitario Granada-Metropolitano (Total)';
                    break;
                case 'distrito-granada':
                    texto = 'üìç Distrito Granada';
                    break;
                case 'distrito-metro':
                    texto = 'üìç Distrito Metropolitano de Granada';
                    break;
                case 'unidad':
                    if (unidadSeleccionada) {
                        const [distrito, unidadId] = unidadSeleccionada.split('-');
                        const unidades = distrito === 'granada' ? CONFIG.unidades_granada : CONFIG.unidades_metro;
                        texto = `üè• Unidad: ${unidades[unidadId]} (${distrito === 'granada' ? 'Granada' : 'Metropolitano'})`;
                    } else {
                        texto = 'üè• Todas las Unidades Asistenciales';
                    }
                    break;
                case 'profesional':
                    if (profesionalSeleccionado) {
                        texto = `üë§ Profesional: ${profesionalSeleccionado}`;
                    } else {
                        texto = 'üë§ Todos los Profesionales';
                    }
                    break;
            }
            document.getElementById('nivel-actual-texto').textContent = texto;
        }
        
        // ===========================
        // ACTUALIZAR DASHBOARD
        // ===========================
        function actualizarDashboard() {
            const metricas = calcularMetricas();
            actualizarKPIs(metricas);
            actualizarGraficos();
            actualizarTabla();
            actualizarRankings();
            
            // Llamar a las mejoras 1-5
            generarAlertas();
            calcularComparativa();
            analizarBrechas();
            mostrarDashboardProfesional(profesionalSeleccionado);
            
            // Llamar a las mejoras 6-10
            mostrarPerfiles();
            calcularMetricasEficiencia();
            calcularPredicciones();
            
            // üÜï Llamar a las mejoras 11-15 (v4.0)
            calcularCorrelaciones();
            calcularBenchmark();
            inicializarModoComparacion();
            inicializarBusquedaAvanzada();
            
            // üÜï Mostrar panel de PDF si hay datos
            mostrarPanelPDF();
        }
        
        function calcularMetricas() {
            const actividades = datosFiltrados.length;
            const participantes = datosFiltrados.reduce((sum, row) => sum + (parseInt(row[CONFIG.campos.participantes]) || 0), 0);
            const hombres = datosFiltrados.reduce((sum, row) => sum + (parseInt(row[CONFIG.campos.hombres]) || 0), 0);
            const mujeres = datosFiltrados.reduce((sum, row) => sum + (parseInt(row[CONFIG.campos.mujeres]) || 0), 0);
            const horas = datosFiltrados.reduce((sum, row) => sum + (parseInt(row[CONFIG.campos.horas]) || 0), 0);
            const sesiones = datosFiltrados.reduce((sum, row) => sum + (parseInt(row[CONFIG.campos.sesiones]) || 0), 0);
            
            return { actividades, participantes, hombres, mujeres, horas, sesiones };
        }
        
        function actualizarKPIs(metricas) {
            document.getElementById('kpi-actividades').textContent = metricas.actividades.toLocaleString('es-ES');
            document.getElementById('kpi-participantes').textContent = metricas.participantes.toLocaleString('es-ES');
            document.getElementById('kpi-horas').textContent = metricas.horas.toLocaleString('es-ES');
            document.getElementById('kpi-sesiones').textContent = metricas.sesiones.toLocaleString('es-ES');
            document.getElementById('kpi-hombres').textContent = metricas.hombres.toLocaleString('es-ES');
            document.getElementById('kpi-mujeres').textContent = metricas.mujeres.toLocaleString('es-ES');
            
            const pctHombres = metricas.participantes > 0 ? ((metricas.hombres / metricas.participantes) * 100).toFixed(1) : 0;
            const pctMujeres = metricas.participantes > 0 ? ((metricas.mujeres / metricas.participantes) * 100).toFixed(1) : 0;
            
            document.getElementById('kpi-hombres-pct').textContent = `${pctHombres}%`;
            document.getElementById('kpi-mujeres-pct').textContent = `${pctMujeres}%`;
        }
        
        // ===========================
        // RANKINGS
        // ===========================
        function actualizarRankings() {
            const container = document.getElementById('rankings-container');
            
            // Mostrar rankings solo en niveles global y de distrito
            if (nivelActual === 'global' || nivelActual === 'distrito-granada' || nivelActual === 'distrito-metro') {
                container.style.display = 'block';
                
                // Ranking por unidades
                crearRankingUnidades();
                
                // Ranking por profesionales
                crearRankingProfesionales();
            } else {
                container.style.display = 'none';
            }
        }
        
        function crearRankingUnidades() {
            const ranking = {};
            
            datosFiltrados.forEach(row => {
                const distrito = String(row[CONFIG.campos.distrito]);
                let unidadNombre = '';
                
                if (distrito === '0') {
                    const unidadId = String(row[CONFIG.campos.unidad_granada]);
                    unidadNombre = CONFIG.unidades_granada[unidadId] ? `${CONFIG.unidades_granada[unidadId]} (Granada)` : 'Sin unidad';
                } else if (distrito === '1') {
                    const unidadId = String(row[CONFIG.campos.unidad_metro]);
                    unidadNombre = CONFIG.unidades_metro[unidadId] ? `${CONFIG.unidades_metro[unidadId]} (Metro)` : 'Sin unidad';
                }
                
                if (unidadNombre) {
                    if (!ranking[unidadNombre]) {
                        ranking[unidadNombre] = {
                            actividades: 0,
                            participantes: 0,
                            horas: 0
                        };
                    }
                    ranking[unidadNombre].actividades++;
                    ranking[unidadNombre].participantes += parseInt(row[CONFIG.campos.participantes]) || 0;
                    ranking[unidadNombre].horas += parseInt(row[CONFIG.campos.horas]) || 0;
                }
            });
            
            const rankingArray = Object.entries(ranking)
                .map(([nombre, datos]) => ({ nombre, ...datos }))
                .sort((a, b) => b.actividades - a.actividades)
                .slice(0, 10);
            
            mostrarRanking('ranking-1', rankingArray, 'actividades');
            document.getElementById('ranking-titulo-1').textContent = 'üèÜ Top 10 Unidades por Actividades';
        }
        
        function crearRankingProfesionales() {
            const ranking = {};
            
            datosFiltrados.forEach(row => {
                const profesional = row[CONFIG.campos.profesional];
                if (profesional) {
                    if (!ranking[profesional]) {
                        ranking[profesional] = {
                            actividades: 0,
                            participantes: 0,
                            horas: 0
                        };
                    }
                    ranking[profesional].actividades++;
                    ranking[profesional].participantes += parseInt(row[CONFIG.campos.participantes]) || 0;
                    ranking[profesional].horas += parseInt(row[CONFIG.campos.horas]) || 0;
                }
            });
            
            const rankingArray = Object.entries(ranking)
                .map(([nombre, datos]) => ({ nombre, ...datos }))
                .sort((a, b) => b.participantes - a.participantes)
                .slice(0, 10);
            
            mostrarRanking('ranking-2', rankingArray, 'participantes');
            document.getElementById('ranking-titulo-2').textContent = 'üë• Top 10 Profesionales por Participantes';
        }
        
        function mostrarRanking(containerId, datos, metrica) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (datos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--color-gris); padding: 20px;">No hay datos para mostrar</p>';
                return;
            }
            
            const maxValor = Math.max(...datos.map(d => d[metrica]));
            
            datos.forEach((item, index) => {
                const porcentaje = (item[metrica] / maxValor) * 100;
                
                const div = document.createElement('div');
                div.className = 'ranking-item';
                div.innerHTML = `
                    <div class="ranking-posicion">${index + 1}</div>
                    <div class="ranking-nombre">${item.nombre}</div>
                    <div class="ranking-barra">
                        <div class="ranking-barra-fill" style="width: ${porcentaje}%"></div>
                    </div>
                    <div class="ranking-valor">${item[metrica].toLocaleString('es-ES')}</div>
                `;
                container.appendChild(div);
            });
        }
        
        // ===========================
        // GR√ÅFICOS
        // ===========================
        function actualizarGraficos() {
            actualizarGraficoTipos();
            actualizarGraficoTematicas();
            actualizarGraficoProgramas();
            actualizarGraficoSexo(calcularMetricas());
            actualizarGraficoComparativo();
            actualizarGraficoMensual();
        }
        
        function contarPor(datos, campo, opciones) {
            const conteo = {};
            datos.forEach(row => {
                const valor = String(row[campo]);
                conteo[valor] = (conteo[valor] || 0) + 1;
            });
            
            return Object.entries(conteo)
                .map(([key, value]) => ({
                    label: opciones[key] || key,
                    value: value
                }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 10);
        }
        
        function actualizarGraficoTipos() {
            const datos = contarPor(datosFiltrados, CONFIG.campos.tipo_actividad, CONFIG.tipos_actividad);
            crearGraficoBarrasHorizontal('grafico-tipos', datos);
        }
        
        function actualizarGraficoTematicas() {
            const datos = contarPor(datosFiltrados, CONFIG.campos.tematica, CONFIG.tematicas);
            crearGraficoBarrasHorizontal('grafico-tematicas', datos);
        }
        
        function actualizarGraficoProgramas() {
            const datos = contarPor(datosFiltrados, CONFIG.campos.programa, CONFIG.programas);
            crearGraficoBarrasHorizontal('grafico-programas', datos);
        }
        
        function actualizarGraficoSexo(metricas) {
            const ctx = document.getElementById('grafico-genero');
            
            if (graficos.sexo) {
                graficos.sexo.destroy();
            }
            
            graficos.sexo = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Hombres', 'Mujeres'],
                    datasets: [{
                        data: [metricas.hombres, metricas.mujeres],
                        backgroundColor: [CONFIG.colores.primario, CONFIG.colores.acento3]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        function actualizarGraficoComparativo() {
            const ctx = document.getElementById('grafico-distritos');
            
            if (graficos.distritos) {
                graficos.distritos.destroy();
            }
            
            let labels, data, titulo;
            
            if (nivelActual === 'global') {
                // Comparativa por distritos
                const granada = datosFiltrados.filter(row => String(row[CONFIG.campos.distrito]) === '0').length;
                const metro = datosFiltrados.filter(row => String(row[CONFIG.campos.distrito]) === '1').length;
                labels = ['Distrito Granada', 'Distrito Metropolitano'];
                data = [granada, metro];
                titulo = 'üìä Comparativa por Distrito';
            } else if (nivelActual === 'distrito-granada' || nivelActual === 'distrito-metro') {
                // Top 5 unidades del distrito
                const ranking = {};
                datosFiltrados.forEach(row => {
                    const distrito = String(row[CONFIG.campos.distrito]);
                    let unidadNombre = '';
                    
                    if (distrito === '0') {
                        const unidadId = String(row[CONFIG.campos.unidad_granada]);
                        unidadNombre = CONFIG.unidades_granada[unidadId] || '';
                    } else {
                        const unidadId = String(row[CONFIG.campos.unidad_metro]);
                        unidadNombre = CONFIG.unidades_metro[unidadId] || '';
                    }
                    
                    if (unidadNombre) {
                        ranking[unidadNombre] = (ranking[unidadNombre] || 0) + 1;
                    }
                });
                
                const top5 = Object.entries(ranking)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                labels = top5.map(([nombre]) => nombre);
                data = top5.map(([, valor]) => valor);
                titulo = 'üèÜ Top 5 Unidades por Actividades';
            } else {
                // Para otros niveles, mostrar evoluci√≥n mensual simple
                labels = ['Actividades'];
                data = [datosFiltrados.length];
                titulo = 'üìä Total de Actividades';
            }
            
            document.getElementById('titulo-grafico-comparativo').textContent = titulo;
            
            graficos.distritos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Actividades',
                        data: data,
                        backgroundColor: CONFIG.colores.paleta
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function actualizarGraficoMensual() {
            const porMes = {};
            datosFiltrados.forEach(row => {
                const fecha = parsearFechaREDCap(row[CONFIG.campos.fecha_inicio]);
                if (fecha) {
                    const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                    porMes[mes] = (porMes[mes] || 0) + 1;
                }
            });
            
            const meses = Object.keys(porMes).sort();
            const valores = meses.map(mes => porMes[mes]);
            
            const ctx = document.getElementById('grafico-mensual');
            
            if (graficos.mensual) {
                graficos.mensual.destroy();
            }
            
            graficos.mensual = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'Actividades',
                        data: valores,
                        borderColor: CONFIG.colores.primario,
                        backgroundColor: CONFIG.colores.primario + '33',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function crearGraficoBarrasHorizontal(idCanvas, datos) {
            const ctx = document.getElementById(idCanvas);
            
            if (graficos[idCanvas]) {
                graficos[idCanvas].destroy();
            }
            
            graficos[idCanvas] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: datos.map(d => d.label),
                    datasets: [{
                        data: datos.map(d => d.value),
                        backgroundColor: CONFIG.colores.paleta
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }
        
        // ===========================
        // TABLA DE DATOS CON PESTA√ëAS
        // ===========================
        
        // Gesti√≥n de pesta√±as
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // Cambiar pesta√±a activa
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');
                
                tabActual = tabName;
            });
        });
        
        function actualizarTabla() {
            actualizarTablaGranada();
            actualizarTablaMetro();
            actualizarTablaAmbos();
        }
        
        function actualizarTablaGranada() {
            const tbody = document.getElementById('tabla-body-granada');
            tbody.innerHTML = '';
            
            const datosGranada = datosFiltrados.filter(row => String(row[CONFIG.campos.distrito]) === '0');
            
            // Ordenar alfab√©ticamente por unidad
            datosGranada.sort((a, b) => {
                const unidadA = CONFIG.unidades_granada[String(a[CONFIG.campos.unidad_granada])] || '';
                const unidadB = CONFIG.unidades_granada[String(b[CONFIG.campos.unidad_granada])] || '';
                return unidadA.localeCompare(unidadB, 'es');
            });
            
            const inicio = (paginacion.granada - 1) * registrosPorPagina;
            const fin = inicio + registrosPorPagina;
            const registrosPagina = datosGranada.slice(inicio, fin);
            
            registrosPagina.forEach(row => {
                const unidadId = String(row[CONFIG.campos.unidad_granada]);
                const unidad = CONFIG.unidades_granada[unidadId] || '-';
                
                const hombres = parseInt(row[CONFIG.campos.hombres]) || 0;
                const mujeres = parseInt(row[CONFIG.campos.mujeres]) || 0;
                const total = parseInt(row[CONFIG.campos.participantes]) || 0;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${unidad}</td>
                    <td>${row[CONFIG.campos.profesional] || '-'}</td>
                    <td>${formatearFecha(row[CONFIG.campos.fecha_inicio])}</td>
                    <td>${CONFIG.tipos_actividad[row[CONFIG.campos.tipo_actividad]] || '-'}</td>
                    <td>${row[CONFIG.campos.nombre_actividad] || '-'}</td>
                    <td>${total} (‚ôÇ${hombres} - ‚ôÄ${mujeres})</td>
                    <td>${row[CONFIG.campos.horas] || 0}</td>
                `;
                tbody.appendChild(tr);
            });
            
            actualizarPaginacionPestana('granada', datosGranada.length);
        }
        
        function actualizarTablaMetro() {
            const tbody = document.getElementById('tabla-body-metro');
            tbody.innerHTML = '';
            
            const datosMetro = datosFiltrados.filter(row => String(row[CONFIG.campos.distrito]) === '1');
            
            // Ordenar alfab√©ticamente por unidad
            datosMetro.sort((a, b) => {
                const unidadA = CONFIG.unidades_metro[String(a[CONFIG.campos.unidad_metro])] || '';
                const unidadB = CONFIG.unidades_metro[String(b[CONFIG.campos.unidad_metro])] || '';
                return unidadA.localeCompare(unidadB, 'es');
            });
            
            const inicio = (paginacion.metro - 1) * registrosPorPagina;
            const fin = inicio + registrosPorPagina;
            const registrosPagina = datosMetro.slice(inicio, fin);
            
            registrosPagina.forEach(row => {
                const unidadId = String(row[CONFIG.campos.unidad_metro]);
                const unidad = CONFIG.unidades_metro[unidadId] || '-';
                
                const hombres = parseInt(row[CONFIG.campos.hombres]) || 0;
                const mujeres = parseInt(row[CONFIG.campos.mujeres]) || 0;
                const total = parseInt(row[CONFIG.campos.participantes]) || 0;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${unidad}</td>
                    <td>${row[CONFIG.campos.profesional] || '-'}</td>
                    <td>${formatearFecha(row[CONFIG.campos.fecha_inicio])}</td>
                    <td>${CONFIG.tipos_actividad[row[CONFIG.campos.tipo_actividad]] || '-'}</td>
                    <td>${row[CONFIG.campos.nombre_actividad] || '-'}</td>
                    <td>${total} (‚ôÇ${hombres} - ‚ôÄ${mujeres})</td>
                    <td>${row[CONFIG.campos.horas] || 0}</td>
                `;
                tbody.appendChild(tr);
            });
            
            actualizarPaginacionPestana('metro', datosMetro.length);
        }
        
        function actualizarTablaAmbos() {
            const tbody = document.getElementById('tabla-body-ambos');
            tbody.innerHTML = '';
            
            // Ordenar primero por distrito y luego alfab√©ticamente por unidad
            const datosOrdenados = [...datosFiltrados].sort((a, b) => {
                const distritoA = String(a[CONFIG.campos.distrito]);
                const distritoB = String(b[CONFIG.campos.distrito]);
                
                // Primero ordenar por distrito (Granada = 0, Metropolitano = 1)
                if (distritoA !== distritoB) {
                    return distritoA.localeCompare(distritoB);
                }
                
                // Luego ordenar por unidad alfab√©ticamente
                let unidadA = '';
                let unidadB = '';
                
                if (distritoA === '0') {
                    unidadA = CONFIG.unidades_granada[String(a[CONFIG.campos.unidad_granada])] || '';
                    unidadB = CONFIG.unidades_granada[String(b[CONFIG.campos.unidad_granada])] || '';
                } else {
                    unidadA = CONFIG.unidades_metro[String(a[CONFIG.campos.unidad_metro])] || '';
                    unidadB = CONFIG.unidades_metro[String(b[CONFIG.campos.unidad_metro])] || '';
                }
                
                return unidadA.localeCompare(unidadB, 'es');
            });
            
            const inicio = (paginacion.ambos - 1) * registrosPorPagina;
            const fin = inicio + registrosPorPagina;
            const registrosPagina = datosOrdenados.slice(inicio, fin);
            
            registrosPagina.forEach(row => {
                const distrito = String(row[CONFIG.campos.distrito]) === '0' ? 'Granada' : 'Metropolitano';
                
                let unidad = '';
                if (String(row[CONFIG.campos.distrito]) === '0') {
                    const unidadId = String(row[CONFIG.campos.unidad_granada]);
                    unidad = CONFIG.unidades_granada[unidadId] || '-';
                } else {
                    const unidadId = String(row[CONFIG.campos.unidad_metro]);
                    unidad = CONFIG.unidades_metro[unidadId] || '-';
                }
                
                const hombres = parseInt(row[CONFIG.campos.hombres]) || 0;
                const mujeres = parseInt(row[CONFIG.campos.mujeres]) || 0;
                const total = parseInt(row[CONFIG.campos.participantes]) || 0;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${distrito}</td>
                    <td>${unidad}</td>
                    <td>${row[CONFIG.campos.profesional] || '-'}</td>
                    <td>${formatearFecha(row[CONFIG.campos.fecha_inicio])}</td>
                    <td>${CONFIG.tipos_actividad[row[CONFIG.campos.tipo_actividad]] || '-'}</td>
                    <td>${row[CONFIG.campos.nombre_actividad] || '-'}</td>
                    <td>${total} (‚ôÇ${hombres} - ‚ôÄ${mujeres})</td>
                    <td>${row[CONFIG.campos.horas] || 0}</td>
                `;
                tbody.appendChild(tr);
            });
            
            actualizarPaginacionPestana('ambos', datosFiltrados.length);
        }
        
        function actualizarPaginacionPestana(pestana, totalRegistros) {
            const totalPaginas = Math.ceil(totalRegistros / registrosPorPagina);
            const paginaActual = paginacion[pestana];
            
            document.getElementById(`paginacion-${pestana}`).textContent = 
                `P√°gina ${paginaActual} de ${totalPaginas} | Total: ${totalRegistros} registros`;
        }
        
        // Botones de paginaci√≥n para Granada
        document.getElementById('btn-anterior-granada').addEventListener('click', function() {
            if (paginacion.granada > 1) {
                paginacion.granada--;
                actualizarTablaGranada();
            }
        });
        
        document.getElementById('btn-siguiente-granada').addEventListener('click', function() {
            const datosGranada = datosFiltrados.filter(row => String(row[CONFIG.campos.distrito]) === '0');
            const totalPaginas = Math.ceil(datosGranada.length / registrosPorPagina);
            if (paginacion.granada < totalPaginas) {
                paginacion.granada++;
                actualizarTablaGranada();
            }
        });
        
        // Botones de paginaci√≥n para Metro
        document.getElementById('btn-anterior-metro').addEventListener('click', function() {
            if (paginacion.metro > 1) {
                paginacion.metro--;
                actualizarTablaMetro();
            }
        });
        
        document.getElementById('btn-siguiente-metro').addEventListener('click', function() {
            const datosMetro = datosFiltrados.filter(row => String(row[CONFIG.campos.distrito]) === '1');
            const totalPaginas = Math.ceil(datosMetro.length / registrosPorPagina);
            if (paginacion.metro < totalPaginas) {
                paginacion.metro++;
                actualizarTablaMetro();
            }
        });
        
        // Botones de paginaci√≥n para Ambos
        document.getElementById('btn-anterior-ambos').addEventListener('click', function() {
            if (paginacion.ambos > 1) {
                paginacion.ambos--;
                actualizarTablaAmbos();
            }
        });
        
        document.getElementById('btn-siguiente-ambos').addEventListener('click', function() {
            const totalPaginas = Math.ceil(datosFiltrados.length / registrosPorPagina);
            if (paginacion.ambos < totalPaginas) {
                paginacion.ambos++;
                actualizarTablaAmbos();
            }
        });
        
        // B√∫squeda en tabla
        document.getElementById('busqueda-tabla').addEventListener('input', function(e) {
            const termino = e.target.value.toLowerCase();
            datosFiltrados = datosOriginales.filter(row => {
                // Aplicar primero los filtros de nivel
                if (nivelActual === 'distrito-granada' && String(row[CONFIG.campos.distrito]) !== '0') return false;
                if (nivelActual === 'distrito-metro' && String(row[CONFIG.campos.distrito]) !== '1') return false;
                
                if (nivelActual === 'unidad' && unidadSeleccionada) {
                    const [distrito, unidadId] = unidadSeleccionada.split('-');
                    if (distrito === 'granada') {
                        if (String(row[CONFIG.campos.distrito]) !== '0' || String(row[CONFIG.campos.unidad_granada]) !== unidadId) return false;
                    } else {
                        if (String(row[CONFIG.campos.distrito]) !== '1' || String(row[CONFIG.campos.unidad_metro]) !== unidadId) return false;
                    }
                }
                
                if (nivelActual === 'profesional' && profesionalSeleccionado) {
                    if (row[CONFIG.campos.profesional] !== profesionalSeleccionado) return false;
                }
                
                // Luego aplicar b√∫squeda
                return String(row[CONFIG.campos.nombre_actividad]).toLowerCase().includes(termino) ||
                       String(row[CONFIG.campos.profesional]).toLowerCase().includes(termino);
            });
            
            // Resetear paginaci√≥n de todas las pesta√±as
            paginacion.granada = 1;
            paginacion.metro = 1;
            paginacion.ambos = 1;
            
            actualizarDashboard();
        });
        
        // ===========================
        // UTILIDADES
        // ===========================
        function parsearFechaREDCap(fechaStr) {
            if (!fechaStr) return null;
            const partes = String(fechaStr).split('/');
            if (partes.length !== 3) return null;
            return new Date(partes[2], partes[1] - 1, partes[0]);
        }
        
        function formatearFecha(fechaStr) {
            const fecha = parsearFechaREDCap(fechaStr);
            if (!fecha) return '-';
            return fecha.toLocaleDateString('es-ES');
        }
        
        function mostrarLoading(mostrar) {
            document.getElementById('loading-overlay').style.display = mostrar ? 'flex' : 'none';
        }
        
        // ===========================
        // EXPORTACI√ìN
        // ===========================
        document.getElementById('btn-exportar-csv').addEventListener('click', function() {
            const csv = Papa.unparse(datosFiltrados);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            let nombreArchivo = 'datos_';
            if (nivelActual === 'distrito-granada') nombreArchivo += 'distrito_granada_';
            else if (nivelActual === 'distrito-metro') nombreArchivo += 'distrito_metro_';
            else if (nivelActual === 'unidad' && unidadSeleccionada) nombreArchivo += 'unidad_';
            else if (nivelActual === 'profesional' && profesionalSeleccionado) nombreArchivo += 'profesional_';
            else nombreArchivo += 'global_';
            
            nombreArchivo += new Date().toISOString().split('T')[0] + '.csv';
            
            link.download = nombreArchivo;
            link.click();
        });
        
        // ===========================
        // MEJORA 1: EXPORTACI√ìN A EXCEL PROFESIONAL
        // ===========================
        document.getElementById('btn-exportar-excel').addEventListener('click', exportarExcelProfesional);
        
        function exportarExcelProfesional() {
            mostrarLoading(true);
            
            try {
                const wb = XLSX.utils.book_new();
                
                // HOJA 1: Resumen Ejecutivo
                const metricas = calcularMetricas();
                const resumenData = [
                    ['REGISTRO DE ACTUACIONES DE PROMOCI√ìN DE LA SALUD'],
                    ['Distrito Sanitario Granada-Metropolitano'],
                    [''],
                    ['M√âTRICAS GLOBALES'],
                    ['Total de actividades', metricas.actividades],
                    ['Total de participantes', metricas.participantes],
                    ['Total de horas', metricas.horas],
                    ['Total de sesiones', metricas.sesiones],
                    ['Participantes hombres', metricas.hombres, `${((metricas.hombres/metricas.participantes)*100).toFixed(1)}%`],
                    ['Participantes mujeres', metricas.mujeres, `${((metricas.mujeres/metricas.participantes)*100).toFixed(1)}%`],
                    [''],
                    ['Nivel de an√°lisis', document.getElementById('nivel-actual-texto').textContent],
                    ['Fecha de generaci√≥n', new Date().toLocaleDateString('es-ES')]
                ];
                
                const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
                wsResumen['!cols'] = [{wch: 30}, {wch: 20}, {wch: 15}];
                XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen Ejecutivo');
                
                // HOJA 2: Distrito Granada
                const datosGranada = datosFiltrados.filter(row => String(row[CONFIG.campos.distrito]) === '0');
                if (datosGranada.length > 0) {
                    const wsGranada = crearHojaDistrito(datosGranada, 'granada');
                    XLSX.utils.book_append_sheet(wb, wsGranada, 'Distrito Granada');
                }
                
                // HOJA 3: Distrito Metropolitano
                const datosMetro = datosFiltrados.filter(row => String(row[CONFIG.campos.distrito]) === '1');
                if (datosMetro.length > 0) {
                    const wsMetro = crearHojaDistrito(datosMetro, 'metro');
                    XLSX.utils.book_append_sheet(wb, wsMetro, 'Distrito Metropolitano');
                }
                
                // HOJA 4: An√°lisis por Unidad
                const wsUnidades = crearAnalisisUnidades();
                XLSX.utils.book_append_sheet(wb, wsUnidades, 'Por Unidad');
                
                // HOJA 5: An√°lisis por Profesional
                const wsProfesionales = crearAnalisisProfesionales();
                XLSX.utils.book_append_sheet(wb, wsProfesionales, 'Por Profesional');
                
                // HOJA 6: An√°lisis por Tem√°tica
                const wsTematicas = crearAnalisisTematicas();
                XLSX.utils.book_append_sheet(wb, wsTematicas, 'Por Tem√°tica');
                
                // HOJA 7: Evoluci√≥n Mensual
                const wsMensual = crearEvolucionMensual();
                XLSX.utils.book_append_sheet(wb, wsMensual, 'Evoluci√≥n Mensual');
                
                // Exportar archivo
                const fecha = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Informe_Promocion_Salud_${fecha}.xlsx`);
                
                mostrarLoading(false);
            } catch (error) {
                console.error('Error al exportar Excel:', error);
                alert('Error al generar el archivo Excel. Por favor, int√©ntelo de nuevo.');
                mostrarLoading(false);
            }
        }
        
        function crearHojaDistrito(datos, distrito) {
            const rows = [
                ['Unidad', 'Profesional', 'Fecha', 'Tipo', 'Actividad', 'Participantes', 'Hombres', 'Mujeres', 'Horas']
            ];
            
            datos.forEach(row => {
                const unidadId = distrito === 'granada' ? 
                    String(row[CONFIG.campos.unidad_granada]) : 
                    String(row[CONFIG.campos.unidad_metro]);
                const unidades = distrito === 'granada' ? CONFIG.unidades_granada : CONFIG.unidades_metro;
                const unidad = unidades[unidadId] || '-';
                
                rows.push([
                    unidad,
                    row[CONFIG.campos.profesional] || '-',
                    formatearFecha(row[CONFIG.campos.fecha_inicio]),
                    CONFIG.tipos_actividad[row[CONFIG.campos.tipo_actividad]] || '-',
                    row[CONFIG.campos.nombre_actividad] || '-',
                    parseInt(row[CONFIG.campos.participantes]) || 0,
                    parseInt(row[CONFIG.campos.hombres]) || 0,
                    parseInt(row[CONFIG.campos.mujeres]) || 0,
                    parseInt(row[CONFIG.campos.horas]) || 0
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(rows);
            ws['!cols'] = [
                {wch: 25}, {wch: 30}, {wch: 12}, {wch: 30}, 
                {wch: 40}, {wch: 13}, {wch: 10}, {wch: 10}, {wch: 8}
            ];
            
            return ws;
        }
        
        function crearAnalisisUnidades() {
            const ranking = {};
            
            datosFiltrados.forEach(row => {
                const distrito = String(row[CONFIG.campos.distrito]);
                let unidadNombre = '';
                
                if (distrito === '0') {
                    const unidadId = String(row[CONFIG.campos.unidad_granada]);
                    unidadNombre = CONFIG.unidades_granada[unidadId] ? 
                        `${CONFIG.unidades_granada[unidadId]} (Granada)` : 'Sin unidad';
                } else if (distrito === '1') {
                    const unidadId = String(row[CONFIG.campos.unidad_metro]);
                    unidadNombre = CONFIG.unidades_metro[unidadId] ? 
                        `${CONFIG.unidades_metro[unidadId]} (Metro)` : 'Sin unidad';
                }
                
                if (unidadNombre) {
                    if (!ranking[unidadNombre]) {
                        ranking[unidadNombre] = {
                            actividades: 0,
                            participantes: 0,
                            hombres: 0,
                            mujeres: 0,
                            horas: 0,
                            sesiones: 0
                        };
                    }
                    ranking[unidadNombre].actividades++;
                    ranking[unidadNombre].participantes += parseInt(row[CONFIG.campos.participantes]) || 0;
                    ranking[unidadNombre].hombres += parseInt(row[CONFIG.campos.hombres]) || 0;
                    ranking[unidadNombre].mujeres += parseInt(row[CONFIG.campos.mujeres]) || 0;
                    ranking[unidadNombre].horas += parseInt(row[CONFIG.campos.horas]) || 0;
                    ranking[unidadNombre].sesiones += parseInt(row[CONFIG.campos.sesiones]) || 0;
                }
            });
            
            const rows = [
                ['Unidad', 'Actividades', 'Participantes', 'Hombres', 'Mujeres', 'Horas', 'Sesiones', 'Promedio Part./Act.']
            ];
            
            Object.entries(ranking)
                .sort((a, b) => b[1].actividades - a[1].actividades)
                .forEach(([unidad, datos]) => {
                    rows.push([
                        unidad,
                        datos.actividades,
                        datos.participantes,
                        datos.hombres,
                        datos.mujeres,
                        datos.horas,
                        datos.sesiones,
                        datos.actividades > 0 ? (datos.participantes / datos.actividades).toFixed(1) : 0
                    ]);
                });
            
            const ws = XLSX.utils.aoa_to_sheet(rows);
            ws['!cols'] = [{wch: 35}, {wch: 12}, {wch: 13}, {wch: 10}, {wch: 10}, {wch: 8}, {wch: 10}, {wch: 18}];
            
            return ws;
        }
        
        function crearAnalisisProfesionales() {
            const ranking = {};
            
            datosFiltrados.forEach(row => {
                const profesional = row[CONFIG.campos.profesional];
                if (profesional) {
                    if (!ranking[profesional]) {
                        ranking[profesional] = {
                            actividades: 0,
                            participantes: 0,
                            hombres: 0,
                            mujeres: 0,
                            horas: 0,
                            sesiones: 0
                        };
                    }
                    ranking[profesional].actividades++;
                    ranking[profesional].participantes += parseInt(row[CONFIG.campos.participantes]) || 0;
                    ranking[profesional].hombres += parseInt(row[CONFIG.campos.hombres]) || 0;
                    ranking[profesional].mujeres += parseInt(row[CONFIG.campos.mujeres]) || 0;
                    ranking[profesional].horas += parseInt(row[CONFIG.campos.horas]) || 0;
                    ranking[profesional].sesiones += parseInt(row[CONFIG.campos.sesiones]) || 0;
                }
            });
            
            const rows = [
                ['Profesional', 'Actividades', 'Participantes', 'Hombres', 'Mujeres', 'Horas', 'Sesiones', 'Promedio Part./Act.']
            ];
            
            Object.entries(ranking)
                .sort((a, b) => b[1].actividades - a[1].actividades)
                .forEach(([profesional, datos]) => {
                    rows.push([
                        profesional,
                        datos.actividades,
                        datos.participantes,
                        datos.hombres,
                        datos.mujeres,
                        datos.horas,
                        datos.sesiones,
                        datos.actividades > 0 ? (datos.participantes / datos.actividades).toFixed(1) : 0
                    ]);
                });
            
            const ws = XLSX.utils.aoa_to_sheet(rows);
            ws['!cols'] = [{wch: 35}, {wch: 12}, {wch: 13}, {wch: 10}, {wch: 10}, {wch: 8}, {wch: 10}, {wch: 18}];
            
            return ws;
        }
        
        function crearAnalisisTematicas() {
            const conteo = {};
            
            datosFiltrados.forEach(row => {
                const tematica = CONFIG.tematicas[row[CONFIG.campos.tematica]] || 'Sin clasificar';
                conteo[tematica] = (conteo[tematica] || 0) + 1;
            });
            
            const rows = [['Tem√°tica', 'N√∫mero de Actividades', 'Porcentaje']];
            const total = datosFiltrados.length;
            
            Object.entries(conteo)
                .sort((a, b) => b[1] - a[1])
                .forEach(([tematica, cantidad]) => {
                    rows.push([
                        tematica,
                        cantidad,
                        `${((cantidad/total)*100).toFixed(1)}%`
                    ]);
                });
            
            const ws = XLSX.utils.aoa_to_sheet(rows);
            ws['!cols'] = [{wch: 40}, {wch: 20}, {wch: 12}];
            
            return ws;
        }
        
        function crearEvolucionMensual() {
            const porMes = {};
            
            datosFiltrados.forEach(row => {
                const fecha = parsearFechaREDCap(row[CONFIG.campos.fecha_inicio]);
                if (fecha) {
                    const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                    if (!porMes[mes]) {
                        porMes[mes] = {
                            actividades: 0,
                            participantes: 0,
                            horas: 0
                        };
                    }
                    porMes[mes].actividades++;
                    porMes[mes].participantes += parseInt(row[CONFIG.campos.participantes]) || 0;
                    porMes[mes].horas += parseInt(row[CONFIG.campos.horas]) || 0;
                }
            });
            
            const rows = [['Mes', 'Actividades', 'Participantes', 'Horas']];
            
            Object.keys(porMes)
                .sort()
                .forEach(mes => {
                    rows.push([
                        mes,
                        porMes[mes].actividades,
                        porMes[mes].participantes,
                        porMes[mes].horas
                    ]);
                });
            
            const ws = XLSX.utils.aoa_to_sheet(rows);
            ws['!cols'] = [{wch: 12}, {wch: 12}, {wch: 13}, {wch: 8}];
            
            return ws;
        }
        
        // ===========================
        // MEJORA 2: COMPARATIVAS TEMPORALES
        // ===========================
        document.getElementById('btn-actualizar-comparativa').addEventListener('click', calcularComparativa);
        
        function calcularComparativa() {
            const periodoActual = document.getElementById('periodo-actual').value;
            const tipoComparacion = document.getElementById('periodo-comparar').value;
            
            const hoy = new Date();
            let fechasActual, fechasAnterior;
            
            switch(periodoActual) {
                case 'mes-actual':
                    fechasActual = {
                        desde: new Date(hoy.getFullYear(), hoy.getMonth(), 1),
                        hasta: new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0)
                    };
                    if (tipoComparacion === 'anterior') {
                        fechasAnterior = {
                            desde: new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1),
                            hasta: new Date(hoy.getFullYear(), hoy.getMonth(), 0)
                        };
                    } else {
                        fechasAnterior = {
                            desde: new Date(hoy.getFullYear() - 1, hoy.getMonth(), 1),
                            hasta: new Date(hoy.getFullYear() - 1, hoy.getMonth() + 1, 0)
                        };
                    }
                    break;
                    
                case 'trimestre-actual':
                    const trimestreActual = Math.floor(hoy.getMonth() / 3);
                    fechasActual = {
                        desde: new Date(hoy.getFullYear(), trimestreActual * 3, 1),
                        hasta: new Date(hoy.getFullYear(), (trimestreActual + 1) * 3, 0)
                    };
                    if (tipoComparacion === 'anterior') {
                        const trimestreAnterior = trimestreActual === 0 ? 3 : trimestreActual - 1;
                        const a√±oAnterior = trimestreActual === 0 ? hoy.getFullYear() - 1 : hoy.getFullYear();
                        fechasAnterior = {
                            desde: new Date(a√±oAnterior, trimestreAnterior * 3, 1),
                            hasta: new Date(a√±oAnterior, (trimestreAnterior + 1) * 3, 0)
                        };
                    } else {
                        fechasAnterior = {
                            desde: new Date(hoy.getFullYear() - 1, trimestreActual * 3, 1),
                            hasta: new Date(hoy.getFullYear() - 1, (trimestreActual + 1) * 3, 0)
                        };
                    }
                    break;
                    
                case 'a√±o-actual':
                    fechasActual = {
                        desde: new Date(hoy.getFullYear(), 0, 1),
                        hasta: new Date(hoy.getFullYear(), 11, 31)
                    };
                    fechasAnterior = {
                        desde: new Date(hoy.getFullYear() - 1, 0, 1),
                        hasta: new Date(hoy.getFullYear() - 1, 11, 31)
                    };
                    break;
            }
            
            const datosActual = filtrarPorPeriodo(datosFiltrados, fechasActual);
            const datosAnterior = filtrarPorPeriodo(datosOriginales, fechasAnterior);
            
            const metricasActual = calcularMetricasPeriodo(datosActual);
            const metricasAnterior = calcularMetricasPeriodo(datosAnterior);
            
            mostrarComparativas(metricasActual, metricasAnterior);
        }
        
        function filtrarPorPeriodo(datos, fechas) {
            return datos.filter(row => {
                const fecha = parsearFechaREDCap(row[CONFIG.campos.fecha_inicio]);
                return fecha && fecha >= fechas.desde && fecha <= fechas.hasta;
            });
        }
        
        function calcularMetricasPeriodo(datos) {
            return {
                actividades: datos.length,
                participantes: datos.reduce((sum, row) => sum + (parseInt(row[CONFIG.campos.participantes]) || 0), 0),
                horas: datos.reduce((sum, row) => sum + (parseInt(row[CONFIG.campos.horas]) || 0), 0),
                sesiones: datos.reduce((sum, row) => sum + (parseInt(row[CONFIG.campos.sesiones]) || 0), 0)
            };
        }
        
        function mostrarComparativas(actual, anterior) {
            const container = document.getElementById('comparativa-cards');
            container.innerHTML = '';
            
            const metricas = [
                {label: 'Actividades', actual: actual.actividades, anterior: anterior.actividades},
                {label: 'Participantes', actual: actual.participantes, anterior: anterior.participantes},
                {label: 'Horas', actual: actual.horas, anterior: anterior.horas},
                {label: 'Sesiones', actual: actual.sesiones, anterior: anterior.sesiones}
            ];
            
            metricas.forEach(metrica => {
                const cambio = metrica.actual - metrica.anterior;
                const cambioPct = metrica.anterior > 0 ? ((cambio / metrica.anterior) * 100).toFixed(1) : 0;
                const clase = cambio > 0 ? 'cambio-positivo' : cambio < 0 ? 'cambio-negativo' : 'cambio-neutro';
                const icono = cambio > 0 ? '‚ñ≤' : cambio < 0 ? '‚ñº' : '‚ïê';
                
                const card = document.createElement('div');
                card.className = 'comparativa-card';
                card.innerHTML = `
                    <div class="comparativa-label">${metrica.label}</div>
                    <div class="comparativa-valores">
                        <span class="valor-actual">${metrica.actual.toLocaleString('es-ES')}</span>
                        <span class="valor-anterior">vs ${metrica.anterior.toLocaleString('es-ES')}</span>
                    </div>
                    <div class="comparativa-cambio ${clase}">
                        ${icono} ${cambio > 0 ? '+' : ''}${cambio.toLocaleString('es-ES')} (${cambioPct}%)
                    </div>
                `;
                container.appendChild(card);
            });
            
            document.getElementById('comparativas-panel').style.display = 'block';
        }
        
        // ===========================
        // MEJORA 3: SISTEMA DE ALERTAS
        // ===========================
        function generarAlertas() {
            const alertas = [];
            
            const haceUnMes = new Date();
            haceUnMes.setMonth(haceUnMes.getMonth() - 1);
            
            const actividadesPorUnidad = {};
            datosFiltrados.forEach(row => {
                const fecha = parsearFechaREDCap(row[CONFIG.campos.fecha_inicio]);
                if (fecha && fecha >= haceUnMes) {
                    const distrito = String(row[CONFIG.campos.distrito]);
                    let unidadNombre = '';
                    
                    if (distrito === '0') {
                        const unidadId = String(row[CONFIG.campos.unidad_granada]);
                        unidadNombre = CONFIG.unidades_granada[unidadId];
                    } else {
                        const unidadId = String(row[CONFIG.campos.unidad_metro]);
                        unidadNombre = CONFIG.unidades_metro[unidadId];
                    }
                    
                    if (unidadNombre) {
                        actividadesPorUnidad[unidadNombre] = (actividadesPorUnidad[unidadNombre] || 0) + 1;
                    }
                }
            });
            
            const todasUnidades = {...CONFIG.unidades_granada, ...CONFIG.unidades_metro};
            Object.values(todasUnidades).forEach(unidad => {
                const actividades = actividadesPorUnidad[unidad] || 0;
                if (actividades < 5) {
                    alertas.push({
                        nivel: 'media',
                        icono: '‚ö†Ô∏è',
                        texto: `La unidad "${unidad}" tiene solo ${actividades} actividades en el √∫ltimo mes`
                    });
                }
            });
            
            const tematicasPrioritarias = {
                '7': 'Consumo de tabaco (PITA)',
                '16': 'Manejo terap√©utico enfermedad (PIOBIN)',
                '19': 'Otras formas de fumar (PSIA)'
            };
            
            const totalActividades = datosFiltrados.length;
            Object.entries(tematicasPrioritarias).forEach(([codigo, nombre]) => {
                const actividadesTematica = datosFiltrados.filter(row => 
                    String(row[CONFIG.campos.tematica]) === codigo
                ).length;
                
                const porcentaje = (actividadesTematica / totalActividades) * 100;
                if (porcentaje < 10) {
                    alertas.push({
                        nivel: 'alta',
                        icono: 'üö®',
                        texto: `Baja cobertura en ${nombre}: solo ${porcentaje.toFixed(1)}% de actividades`
                    });
                }
            });
            
            const haceDosMeses = new Date();
            haceDosMeses.setMonth(haceDosMeses.getMonth() - 2);
            
            const profesionalesActivos = new Set();
            datosFiltrados.forEach(row => {
                const fecha = parsearFechaREDCap(row[CONFIG.campos.fecha_inicio]);
                if (fecha && fecha >= haceDosMeses) {
                    profesionalesActivos.add(row[CONFIG.campos.profesional]);
                }
            });
            
            const todosProfesionales = new Set(datosOriginales.map(row => row[CONFIG.campos.profesional]).filter(Boolean));
            const inactivos = [...todosProfesionales].filter(prof => !profesionalesActivos.has(prof));
            
            if (inactivos.length > 0 && inactivos.length < 10) {
                alertas.push({
                    nivel: 'baja',
                    icono: '‚ÑπÔ∏è',
                    texto: `${inactivos.length} profesionales sin actividad en los √∫ltimos 2 meses`
                });
            }
            
            const metricas = calcularMetricas();
            if (metricas.participantes > 0) {
                const pctHombres = (metricas.hombres / metricas.participantes) * 100;
                
                if (pctHombres < 30) {
                    alertas.push({
                        nivel: 'media',
                        icono: '‚ö†Ô∏è',
                        texto: `Baja participaci√≥n masculina: ${pctHombres.toFixed(1)}%. Revisar estrategias de captaci√≥n`
                    });
                } else if (pctHombres > 70) {
                    alertas.push({
                        nivel: 'media',
                        icono: '‚ö†Ô∏è',
                        texto: `Baja participaci√≥n femenina: ${(100-pctHombres).toFixed(1)}%. Revisar estrategias de captaci√≥n`
                    });
                }
            }
            
            mostrarAlertas(alertas);
        }
        
        function mostrarAlertas(alertas) {
            if (alertas.length === 0) {
                document.getElementById('alertas-panel').style.display = 'none';
                return;
            }
            
            const container = document.getElementById('alertas-container');
            container.innerHTML = '';
            
            alertas.forEach(alerta => {
                const div = document.createElement('div');
                div.className = 'alerta-item';
                div.innerHTML = `
                    <div class="alerta-icono">${alerta.icono}</div>
                    <div class="alerta-texto">${alerta.texto}</div>
                    <div class="alerta-nivel alerta-${alerta.nivel}">${alerta.nivel.toUpperCase()}</div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('alertas-panel').style.display = 'block';
        }
        
        // ===========================
        // MEJORA 4: DASHBOARD PROFESIONAL INDIVIDUAL
        // ===========================
        function mostrarDashboardProfesional(profesional) {
            if (!profesional || nivelActual !== 'profesional') {
                document.getElementById('dashboard-profesional').style.display = 'none';
                return;
            }
            
            const datosProfesional = datosFiltrados.filter(row => 
                row[CONFIG.campos.profesional] === profesional
            );
            
            if (datosProfesional.length === 0) {
                document.getElementById('dashboard-profesional').style.display = 'none';
                return;
            }
            
            const metricasProfesional = {
                actividades: datosProfesional.length,
                participantes: datosProfesional.reduce((sum, row) => 
                    sum + (parseInt(row[CONFIG.campos.participantes]) || 0), 0),
                horas: datosProfesional.reduce((sum, row) => 
                    sum + (parseInt(row[CONFIG.campos.horas]) || 0), 0),
                sesiones: datosProfesional.reduce((sum, row) => 
                    sum + (parseInt(row[CONFIG.campos.sesiones]) || 0), 0)
            };
            
            const todosProfesionales = {};
            datosFiltrados.forEach(row => {
                const prof = row[CONFIG.campos.profesional];
                if (prof) {
                    if (!todosProfesionales[prof]) {
                        todosProfesionales[prof] = {
                            actividades: 0,
                            participantes: 0,
                            horas: 0
                        };
                    }
                    todosProfesionales[prof].actividades++;
                    todosProfesionales[prof].participantes += parseInt(row[CONFIG.campos.participantes]) || 0;
                    todosProfesionales[prof].horas += parseInt(row[CONFIG.campos.horas]) || 0;
                }
            });
            
            const numProfesionales = Object.keys(todosProfesionales).length;
            const promedioActividades = Object.values(todosProfesionales).reduce((sum, p) => 
                sum + p.actividades, 0) / numProfesionales;
            const promedioParticipantes = Object.values(todosProfesionales).reduce((sum, p) => 
                sum + p.participantes, 0) / numProfesionales;
            
            const rankingActividades = Object.entries(todosProfesionales)
                .sort((a, b) => b[1].actividades - a[1].actividades);
            const posicionRanking = rankingActividades.findIndex(([prof]) => prof === profesional) + 1;
            
            document.getElementById('profesional-nombre').textContent = profesional;
            
            const infoContainer = document.getElementById('profesional-info');
            infoContainer.innerHTML = `
                <div class="profesional-metrica">
                    <div class="profesional-metrica-valor">${metricasProfesional.actividades}</div>
                    <div class="profesional-metrica-label">Mis Actividades</div>
                    <div class="profesional-metrica-comparativa">
                        Promedio distrito: ${promedioActividades.toFixed(1)}
                        ${metricasProfesional.actividades > promedioActividades ? '‚ñ≤' : '‚ñº'}
                    </div>
                </div>
                <div class="profesional-metrica">
                    <div class="profesional-metrica-valor">${metricasProfesional.participantes}</div>
                    <div class="profesional-metrica-label">Mis Participantes</div>
                    <div class="profesional-metrica-comparativa">
                        Promedio distrito: ${promedioParticipantes.toFixed(1)}
                        ${metricasProfesional.participantes > promedioParticipantes ? '‚ñ≤' : '‚ñº'}
                    </div>
                </div>
                <div class="profesional-metrica">
                    <div class="profesional-metrica-valor">${metricasProfesional.horas}</div>
                    <div class="profesional-metrica-label">Horas Dedicadas</div>
                </div>
                <div class="profesional-metrica">
                    <div class="profesional-metrica-valor">#${posicionRanking}</div>
                    <div class="profesional-metrica-label">Ranking por Actividades</div>
                    <div class="profesional-metrica-comparativa">
                        Entre ${numProfesionales} profesionales
                    </div>
                </div>
            `;
            
            document.getElementById('dashboard-profesional').style.display = 'block';
        }
        
        // ===========================
        // MEJORA 5: AN√ÅLISIS DE BRECHAS
        // ===========================
        function analizarBrechas() {
            const brechas = {
                unidadesBajas: [],
                tematicasBajas: [],
                zonasDesfavorecidas: 0
            };
            
            const actividadesPorUnidad = {};
            datosFiltrados.forEach(row => {
                const distrito = String(row[CONFIG.campos.distrito]);
                let unidadNombre = '';
                
                if (distrito === '0') {
                    const unidadId = String(row[CONFIG.campos.unidad_granada]);
                    unidadNombre = CONFIG.unidades_granada[unidadId];
                } else {
                    const unidadId = String(row[CONFIG.campos.unidad_metro]);
                    unidadNombre = CONFIG.unidades_metro[unidadId];
                }
                
                if (unidadNombre) {
                    actividadesPorUnidad[unidadNombre] = (actividadesPorUnidad[unidadNombre] || 0) + 1;
                }
            });
            
            brechas.unidadesBajas = Object.entries(actividadesPorUnidad)
                .sort((a, b) => a[1] - b[1])
                .slice(0, 5);
            
            const total = datosFiltrados.length;
            const porTematica = {};
            
            datosFiltrados.forEach(row => {
                const tematica = CONFIG.tematicas[row[CONFIG.campos.tematica]] || 'Sin clasificar';
                porTematica[tematica] = (porTematica[tematica] || 0) + 1;
            });
            
            brechas.tematicasBajas = Object.entries(porTematica)
                .filter(([, count]) => (count / total) < 0.05)
                .sort((a, b) => a[1] - b[1]);
            
            brechas.zonasDesfavorecidas = datosFiltrados.filter(row => 
                String(row['es_una_zona_desfavorecidas']) === '1'
            ).length;
            
            mostrarBrechas(brechas);
        }
        
        function mostrarBrechas(brechas) {
            if (brechas.unidadesBajas.length === 0 && brechas.tematicasBajas.length === 0) {
                document.getElementById('brechas-panel').style.display = 'none';
                return;
            }
            
            const container = document.getElementById('brechas-grid');
            container.innerHTML = '';
            
            if (brechas.unidadesBajas.length > 0) {
                const cardUnidades = document.createElement('div');
                cardUnidades.className = 'brecha-card';
                cardUnidades.innerHTML = `
                    <h3>üè• Unidades con Menor Actividad</h3>
                    <ul class="brecha-lista">
                        ${brechas.unidadesBajas.map(([unidad, count]) => `
                            <li class="brecha-item">
                                <span class="brecha-nombre">${unidad}</span>
                                <span class="brecha-valor">${count} actividades</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
                container.appendChild(cardUnidades);
            }
            
            if (brechas.tematicasBajas.length > 0) {
                const cardTematicas = document.createElement('div');
                cardTematicas.className = 'brecha-card';
                cardTematicas.innerHTML = `
                    <h3>üìö Tem√°ticas con Baja Cobertura (<5%)</h3>
                    <ul class="brecha-lista">
                        ${brechas.tematicasBajas.slice(0, 5).map(([tematica, count]) => `
                            <li class="brecha-item">
                                <span class="brecha-nombre">${tematica}</span>
                                <span class="brecha-valor">${count} actividades</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
                container.appendChild(cardTematicas);
            }
            
            const cardZonas = document.createElement('div');
            cardZonas.className = 'brecha-card';
            const pctZonas = datosFiltrados.length > 0 ? ((brechas.zonasDesfavorecidas / datosFiltrados.length) * 100).toFixed(1) : 0;
            cardZonas.innerHTML = `
                <h3>üìç Cobertura en Zonas Desfavorecidas</h3>
                <div style="padding: 20px; text-align: center;">
                    <div style="font-size: 48px; font-weight: 700; color: var(--color-acento2); margin-bottom: 10px;">
                        ${brechas.zonasDesfavorecidas}
                    </div>
                    <div style="font-size: 14px; color: var(--color-gris);">
                        Actividades en zonas ZNTS/ERACIS
                    </div>
                    <div style="font-size: 14px; color: var(--color-gris); margin-top: 10px;">
                        ${pctZonas}% del total
                    </div>
                </div>
            `;
            container.appendChild(cardZonas);
            
            document.getElementById('brechas-panel').style.display = 'block';
        }
        
        // ===========================
        // MEJORA 6: FILTROS GUARDADOS / PERFILES
        // ===========================
        let perfilesGuardados = [];
        
        function cargarPerfiles() {
            const stored = localStorage.getItem('perfiles_promocion_salud');
            if (stored) {
                perfilesGuardados = JSON.parse(stored);
                mostrarPerfiles();
            }
        }
        
        function guardarPerfil() {
            const nombre = document.getElementById('perfil-nombre-input').value.trim();
            if (!nombre) {
                alert('Por favor, introduce un nombre para el perfil');
                return;
            }
            
            if (perfilesGuardados.length >= 5) {
                alert('Has alcanzado el l√≠mite de 5 perfiles. Elimina uno antes de crear otro.');
                return;
            }
            
            const perfil = {
                nombre: nombre,
                nivel: nivelActual,
                unidad: unidadSeleccionada,
                profesional: profesionalSeleccionado,
                fechaDesde: document.getElementById('filtro-fecha-desde').value,
                fechaHasta: document.getElementById('filtro-fecha-hasta').value,
                tipoActividad: document.getElementById('filtro-tipo-actividad').value,
                tematica: document.getElementById('filtro-tematica').value,
                programa: document.getElementById('filtro-programa').value
            };
            
            perfilesGuardados.push(perfil);
            localStorage.setItem('perfiles_promocion_salud', JSON.stringify(perfilesGuardados));
            
            document.getElementById('perfil-nombre-input').value = '';
            mostrarPerfiles();
            
            alert(`‚úÖ Perfil "${nombre}" guardado correctamente`);
        }
        
        function mostrarPerfiles() {
            if (perfilesGuardados.length === 0) {
                document.getElementById('perfiles-panel').style.display = 'none';
                return;
            }
            
            const container = document.getElementById('perfiles-lista');
            container.innerHTML = '';
            
            perfilesGuardados.forEach((perfil, index) => {
                const div = document.createElement('div');
                div.className = 'perfil-item';
                div.innerHTML = `
                    <span class="perfil-nombre">${perfil.nombre}</span>
                    <button class="perfil-eliminar" data-index="${index}">‚úï</button>
                `;
                
                div.querySelector('.perfil-nombre').addEventListener('click', () => cargarPerfil(perfil));
                div.querySelector('.perfil-eliminar').addEventListener('click', (e) => {
                    e.stopPropagation();
                    eliminarPerfil(index);
                });
                
                container.appendChild(div);
            });
            
            document.getElementById('perfiles-panel').style.display = 'block';
        }
        
        function cargarPerfil(perfil) {
            document.getElementById('nivel-agregacion').value = perfil.nivel;
            
            nivelActual = perfil.nivel;
            unidadSeleccionada = perfil.unidad || '';
            profesionalSeleccionado = perfil.profesional || '';
            
            document.getElementById('grupo-unidad').style.display = nivelActual === 'unidad' ? 'block' : 'none';
            document.getElementById('grupo-profesional').style.display = nivelActual === 'profesional' ? 'block' : 'none';
            
            if (perfil.unidad) document.getElementById('select-unidad').value = perfil.unidad;
            if (perfil.profesional) document.getElementById('select-profesional').value = perfil.profesional;
            
            document.getElementById('filtro-fecha-desde').value = perfil.fechaDesde || '';
            document.getElementById('filtro-fecha-hasta').value = perfil.fechaHasta || '';
            document.getElementById('filtro-tipo-actividad').value = perfil.tipoActividad || '';
            document.getElementById('filtro-tematica').value = perfil.tematica || '';
            document.getElementById('filtro-programa').value = perfil.programa || '';
            
            aplicarFiltros();
            
            alert(`‚úÖ Perfil "${perfil.nombre}" cargado`);
        }
        
        function eliminarPerfil(index) {
            if (confirm(`¬øEliminar el perfil "${perfilesGuardados[index].nombre}"?`)) {
                perfilesGuardados.splice(index, 1);
                localStorage.setItem('perfiles_promocion_salud', JSON.stringify(perfilesGuardados));
                mostrarPerfiles();
            }
        }
        
        document.getElementById('btn-guardar-perfil').addEventListener('click', guardarPerfil);
        
        // ===========================
        // MEJORA 7: M√âTRICAS DE EFICIENCIA
        // ===========================
        function calcularMetricasEficiencia() {
            if (datosFiltrados.length === 0) {
                document.getElementById('eficiencia-panel').style.display = 'none';
                return;
            }
            
            const metricas = calcularMetricas();
            
            const promedioParticipantes = metricas.actividades > 0 ? 
                (metricas.participantes / metricas.actividades).toFixed(1) : 0;
            
            const horasPorParticipante = metricas.participantes > 0 ? 
                (metricas.horas / metricas.participantes).toFixed(2) : 0;
            
            const ratioSesiones = metricas.actividades > 0 ? 
                (metricas.sesiones / metricas.actividades).toFixed(1) : 0;
            
            const tematicasUnicas = new Set(datosFiltrados.map(row => row[CONFIG.campos.tematica])).size;
            const indiceDiversidad = metricas.actividades > 0 ? 
                (tematicasUnicas / metricas.actividades * 100).toFixed(1) : 0;
            
            const unidadesActivas = new Set();
            datosFiltrados.forEach(row => {
                const distrito = String(row[CONFIG.campos.distrito]);
                if (distrito === '0') {
                    const unidadId = String(row[CONFIG.campos.unidad_granada]);
                    if (CONFIG.unidades_granada[unidadId]) unidadesActivas.add(unidadId);
                } else if (distrito === '1') {
                    const unidadId = String(row[CONFIG.campos.unidad_metro]);
                    if (CONFIG.unidades_metro[unidadId]) unidadesActivas.add(unidadId);
                }
            });
            
            const totalUnidades = Object.keys(CONFIG.unidades_granada).length + Object.keys(CONFIG.unidades_metro).length;
            const coberturaUnidades = ((unidadesActivas.size / totalUnidades) * 100).toFixed(1);
            
            const container = document.getElementById('eficiencia-grid');
            container.innerHTML = `
                <div class="eficiencia-card">
                    <div class="eficiencia-valor">${promedioParticipantes}</div>
                    <div class="eficiencia-label">Participantes/Actividad</div>
                    <div class="eficiencia-descripcion">Promedio de personas por actividad</div>
                </div>
                <div class="eficiencia-card">
                    <div class="eficiencia-valor">${horasPorParticipante}</div>
                    <div class="eficiencia-label">Horas/Participante</div>
                    <div class="eficiencia-descripcion">Tiempo dedicado por persona</div>
                </div>
                <div class="eficiencia-card">
                    <div class="eficiencia-valor">${ratioSesiones}</div>
                    <div class="eficiencia-label">Sesiones/Actividad</div>
                    <div class="eficiencia-descripcion">N√∫mero medio de sesiones</div>
                </div>
                <div class="eficiencia-card">
                    <div class="eficiencia-valor">${indiceDiversidad}%</div>
                    <div class="eficiencia-label">Diversidad Tem√°tica</div>
                    <div class="eficiencia-descripcion">${tematicasUnicas} tem√°ticas diferentes</div>
                </div>
                <div class="eficiencia-card">
                    <div class="eficiencia-valor">${coberturaUnidades}%</div>
                    <div class="eficiencia-label">Cobertura Unidades</div>
                    <div class="eficiencia-descripcion">${unidadesActivas.size} de ${totalUnidades} unidades activas</div>
                </div>
            `;
            
            document.getElementById('eficiencia-panel').style.display = 'block';
        }
        
        // ===========================
        // MEJORA 8: MODO PRESENTACI√ìN
        // ===========================
        let slideActual = 1;
        let totalSlides = 4;
        let autoPlay = false;
        let autoPlayInterval = null;
        
        document.getElementById('btn-modo-presentacion').addEventListener('click', activarModoPresentacion);
        document.getElementById('btn-salir-presentacion').addEventListener('click', desactivarModoPresentacion);
        document.getElementById('btn-prev-slide').addEventListener('click', () => cambiarSlide(-1));
        document.getElementById('btn-next-slide').addEventListener('click', () => cambiarSlide(1));
        document.getElementById('btn-play-pause').addEventListener('click', toggleAutoPlay);
        
        document.addEventListener('keydown', function(e) {
            const presentacion = document.getElementById('modo-presentacion');
            if (presentacion.classList.contains('active')) {
                if (e.key === 'ArrowLeft') cambiarSlide(-1);
                else if (e.key === 'ArrowRight') cambiarSlide(1);
                else if (e.key === 'Escape') desactivarModoPresentacion();
                else if (e.key === ' ') toggleAutoPlay();
            }
        });
        
        function activarModoPresentacion() {
            if (datosFiltrados.length === 0) {
                alert('Por favor, carga datos primero');
                return;
            }
            
            const metricas = calcularMetricas();
            
            const slide1 = document.getElementById('presentacion-kpis-slide1');
            slide1.innerHTML = `
                <div class="presentacion-kpi">
                    <div class="presentacion-kpi-valor">${metricas.actividades}</div>
                    <div class="presentacion-kpi-label">Actividades</div>
                </div>
                <div class="presentacion-kpi">
                    <div class="presentacion-kpi-valor">${metricas.participantes.toLocaleString('es-ES')}</div>
                    <div class="presentacion-kpi-label">Participantes</div>
                </div>
                <div class="presentacion-kpi">
                    <div class="presentacion-kpi-valor">${metricas.horas.toLocaleString('es-ES')}</div>
                    <div class="presentacion-kpi-label">Horas</div>
                </div>
                <div class="presentacion-kpi">
                    <div class="presentacion-kpi-valor">${metricas.sesiones.toLocaleString('es-ES')}</div>
                    <div class="presentacion-kpi-label">Sesiones</div>
                </div>
            `;
            
            const pctHombres = metricas.participantes > 0 ? ((metricas.hombres / metricas.participantes) * 100).toFixed(1) : 0;
            const pctMujeres = metricas.participantes > 0 ? ((metricas.mujeres / metricas.participantes) * 100).toFixed(1) : 0;
            
            const slide4 = document.getElementById('presentacion-kpis-slide4');
            slide4.innerHTML = `
                <div class="presentacion-kpi">
                    <div class="presentacion-kpi-valor">${metricas.hombres.toLocaleString('es-ES')}</div>
                    <div class="presentacion-kpi-label">‚ôÇÔ∏è Hombres (${pctHombres}%)</div>
                </div>
                <div class="presentacion-kpi">
                    <div class="presentacion-kpi-valor">${metricas.mujeres.toLocaleString('es-ES')}</div>
                    <div class="presentacion-kpi-label">‚ôÄÔ∏è Mujeres (${pctMujeres}%)</div>
                </div>
            `;
            
            crearGraficoPresentacion();
            
            document.getElementById('modo-presentacion').classList.add('active');
            slideActual = 1;
            mostrarSlide(slideActual);
        }
        
        function desactivarModoPresentacion() {
            document.getElementById('modo-presentacion').classList.remove('active');
            if (autoPlay) toggleAutoPlay();
        }
        
        function cambiarSlide(direccion) {
            slideActual += direccion;
            if (slideActual < 1) slideActual = totalSlides;
            if (slideActual > totalSlides) slideActual = 1;
            mostrarSlide(slideActual);
        }
        
        function mostrarSlide(numero) {
            document.querySelectorAll('.presentacion-slide').forEach((slide, index) => {
                slide.classList.toggle('active', index + 1 === numero);
            });
            document.getElementById('presentacion-indicador').textContent = `${numero} / ${totalSlides}`;
        }
        
        function toggleAutoPlay() {
            autoPlay = !autoPlay;
            const btn = document.getElementById('btn-play-pause');
            
            if (autoPlay) {
                btn.textContent = '‚è∏ Pausar';
                autoPlayInterval = setInterval(() => cambiarSlide(1), 5000);
            } else {
                btn.textContent = '‚ñ∂ Auto';
                clearInterval(autoPlayInterval);
            }
        }
        
        function crearGraficoPresentacion() {
            const conteoTipos = {};
            datosFiltrados.forEach(row => {
                const tipo = CONFIG.tipos_actividad[row[CONFIG.campos.tipo_actividad]] || 'Sin clasificar';
                conteoTipos[tipo] = (conteoTipos[tipo] || 0) + 1;
            });
            
            const dataTipos = Object.entries(conteoTipos)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx2 = document.getElementById('presentacion-grafico-tipos').getContext('2d');
            if (window.chartPresentacionTipos) window.chartPresentacionTipos.destroy();
            window.chartPresentacionTipos = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: dataTipos.map(([tipo]) => tipo),
                    datasets: [{
                        label: 'Actividades',
                        data: dataTipos.map(([, count]) => count),
                        backgroundColor: 'rgba(25, 118, 210, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#fff' } },
                        x: { ticks: { color: '#fff' } }
                    }
                }
            });
            
            const conteoTematicas = {};
            datosFiltrados.forEach(row => {
                const tematica = CONFIG.tematicas[row[CONFIG.campos.tematica]] || 'Sin clasificar';
                conteoTematicas[tematica] = (conteoTematicas[tematica] || 0) + 1;
            });
            
            const dataTematicas = Object.entries(conteoTematicas)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx3 = document.getElementById('presentacion-grafico-tematicas').getContext('2d');
            if (window.chartPresentacionTematicas) window.chartPresentacionTematicas.destroy();
            window.chartPresentacionTematicas = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: dataTematicas.map(([tema]) => tema),
                    datasets: [{
                        label: 'Actividades',
                        data: dataTematicas.map(([, count]) => count),
                        backgroundColor: 'rgba(56, 142, 60, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#fff' } },
                        x: { ticks: { color: '#fff' } }
                    }
                }
            });
        }
        
        // ===========================
        // MEJORA 9: AN√ÅLISIS PREDICTIVO
        // ===========================
        function calcularPredicciones() {
            if (datosFiltrados.length < 10) {
                document.getElementById('predictivo-panel').style.display = 'none';
                return;
            }
            
            const porMes = {};
            datosFiltrados.forEach(row => {
                const fecha = parsearFechaREDCap(row[CONFIG.campos.fecha_inicio]);
                if (fecha) {
                    const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                    if (!porMes[mes]) {
                        porMes[mes] = { actividades: 0, participantes: 0, horas: 0 };
                    }
                    porMes[mes].actividades++;
                    porMes[mes].participantes += parseInt(row[CONFIG.campos.participantes]) || 0;
                    porMes[mes].horas += parseInt(row[CONFIG.campos.horas]) || 0;
                }
            });
            
            const meses = Object.keys(porMes).sort();
            if (meses.length < 3) {
                document.getElementById('predictivo-panel').style.display = 'none';
                return;
            }
            
            const ultimos3Meses = meses.slice(-3);
            const promedioActividades = ultimos3Meses.reduce((sum, mes) => sum + porMes[mes].actividades, 0) / 3;
            const promedioParticipantes = ultimos3Meses.reduce((sum, mes) => sum + porMes[mes].participantes, 0) / 3;
            const promedioHoras = ultimos3Meses.reduce((sum, mes) => sum + porMes[mes].horas, 0) / 3;
            
            const actividadMesAnterior = porMes[ultimos3Meses[ultimos3Meses.length - 1]].actividades;
            const tendenciaActividades = actividadMesAnterior > promedioActividades ? 'positiva' : 
                                        actividadMesAnterior < promedioActividades ? 'negativa' : 'estable';
            
            const container = document.getElementById('predictivo-cards');
            container.innerHTML = `
                <div class="predictivo-card">
                    <div class="predictivo-periodo">Proyecci√≥n pr√≥ximo mes</div>
                    <div class="predictivo-valor">${Math.round(promedioActividades)}</div>
                    <div class="predictivo-label">Actividades estimadas</div>
                    <div class="predictivo-tendencia tendencia-${tendenciaActividades}">
                        ${tendenciaActividades === 'positiva' ? '‚ñ≤ Tendencia alcista' : 
                          tendenciaActividades === 'negativa' ? '‚ñº Tendencia bajista' : 
                          '‚ïê Tendencia estable'}
                    </div>
                </div>
                <div class="predictivo-card">
                    <div class="predictivo-periodo">Proyecci√≥n pr√≥ximo mes</div>
                    <div class="predictivo-valor">${Math.round(promedioParticipantes)}</div>
                    <div class="predictivo-label">Participantes estimados</div>
                    <div class="predictivo-tendencia">
                        Basado en media m√≥vil (√∫ltimos 3 meses)
                    </div>
                </div>
                <div class="predictivo-card">
                    <div class="predictivo-periodo">Proyecci√≥n pr√≥ximo mes</div>
                    <div class="predictivo-valor">${Math.round(promedioHoras)}</div>
                    <div class="predictivo-label">Horas estimadas</div>
                    <div class="predictivo-tendencia">
                        Basado en media m√≥vil (√∫ltimos 3 meses)
                    </div>
                </div>
            `;
            
            crearGraficoPredictivo(porMes, meses, promedioActividades);
            
            document.getElementById('predictivo-panel').style.display = 'block';
        }
        
        function crearGraficoPredictivo(porMes, meses, promedioProximo) {
            const mesesRecientes = meses.slice(-6);
            const datosReales = mesesRecientes.map(mes => porMes[mes].actividades);
            
            const proximoMes = new Date(mesesRecientes[mesesRecientes.length - 1] + '-01');
            proximoMes.setMonth(proximoMes.getMonth() + 1);
            const proximoMesStr = `${proximoMes.getFullYear()}-${String(proximoMes.getMonth() + 1).padStart(2, '0')}`;
            
            const ctx = document.getElementById('grafico-predictivo').getContext('2d');
            if (window.chartPredictivo) window.chartPredictivo.destroy();
            
            window.chartPredictivo = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [...mesesRecientes, proximoMesStr],
                    datasets: [
                        {
                            label: 'Actividades reales',
                            data: datosReales,
                            borderColor: 'rgba(25, 118, 210, 1)',
                            backgroundColor: 'rgba(25, 118, 210, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Proyecci√≥n',
                            data: [...Array(mesesRecientes.length).fill(null), Math.round(promedioProximo)],
                            borderColor: 'rgba(156, 39, 176, 1)',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#fff' }
                        },
                        title: {
                            display: true,
                            text: 'Evoluci√≥n y Proyecci√≥n de Actividades',
                            color: '#fff',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#fff' }
                        },
                        x: { 
                            ticks: { color: '#fff' }
                        }
                    }
                }
            });
        }
        
        // ===========================
        // MEJORA 10: EXPORTACI√ìN DE GR√ÅFICOS
        // ===========================
        document.querySelectorAll('.grafico-export-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const chartId = this.getAttribute('data-chart');
                exportarGrafico(chartId);
            });
        });
        
        function exportarGrafico(chartId) {
            const canvas = document.getElementById(chartId);
            if (!canvas) return;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const ctx = tempCanvas.getContext('2d');
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            ctx.drawImage(canvas, 0, 0);
            
            ctx.fillStyle = '#1976d2';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Distrito Sanitario Granada-Metropolitano', 20, tempCanvas.height - 20);
            
            const link = document.createElement('a');
            link.download = `grafico_${chartId}_${new Date().toISOString().split('T')[0]}.png`;
            link.href = tempCanvas.toDataURL('image/png', 1.0);
            link.click();
        }
        
        // ========================================
        // üÜï MEJORA 11: AN√ÅLISIS DE CORRELACIONES
        // ========================================
        
        function calcularCorrelaciones() {
            if (datosFiltrados.length < 10) {
                document.getElementById('correlaciones-panel').style.display = 'none';
                return;
            }
            
            // Calcular correlaci√≥n entre Participantes y Horas
            const corrParticipantesHoras = calcularCorrelacionPearson(
                datosFiltrados.map(r => parseInt(r[CONFIG.campos.participantes]) || 0),
                datosFiltrados.map(r => parseInt(r[CONFIG.campos.horas]) || 0)
            );
            
            // Calcular correlaci√≥n entre Participantes y Sesiones
            const corrParticipantesSesiones = calcularCorrelacionPearson(
                datosFiltrados.map(r => parseInt(r[CONFIG.campos.participantes]) || 0),
                datosFiltrados.map(r => parseInt(r[CONFIG.campos.sesiones]) || 0)
            );
            
            // Calcular correlaci√≥n entre Horas y Sesiones
            const corrHorasSesiones = calcularCorrelacionPearson(
                datosFiltrados.map(r => parseInt(r[CONFIG.campos.horas]) || 0),
                datosFiltrados.map(r => parseInt(r[CONFIG.campos.sesiones]) || 0)
            );
            
            const container = document.getElementById('correlaciones-grid');
            container.innerHTML = '';
            
            // Participantes vs Horas
            const card1 = crearTarjetaCorrelacion(
                corrParticipantesHoras,
                'Participantes vs Horas',
                '¬øA m√°s participantes, m√°s horas dedicadas?'
            );
            container.appendChild(card1);
            
            // Participantes vs Sesiones
            const card2 = crearTarjetaCorrelacion(
                corrParticipantesSesiones,
                'Participantes vs Sesiones',
                '¬øA m√°s participantes, m√°s sesiones?'
            );
            container.appendChild(card2);
            
            // Horas vs Sesiones
            const card3 = crearTarjetaCorrelacion(
                corrHorasSesiones,
                'Horas vs Sesiones',
                '¬øA m√°s sesiones, m√°s horas totales?'
            );
            container.appendChild(card3);
            
            document.getElementById('correlaciones-panel').style.display = 'block';
        }
        
        function calcularCorrelacionPearson(x, y) {
            const n = x.length;
            if (n === 0) return 0;
            
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
            
            const numerador = n * sumXY - sumX * sumY;
            const denominador = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            if (denominador === 0) return 0;
            return numerador / denominador;
        }
        
        function crearTarjetaCorrelacion(valor, label, interpretacion) {
            const div = document.createElement('div');
            div.className = 'correlacion-item';
            
            let clase = 'correlacion-neutra';
            let texto = 'Correlaci√≥n d√©bil o nula';
            
            if (valor > 0.7) {
                clase = 'correlacion-positiva';
                texto = 'Correlaci√≥n positiva fuerte';
            } else if (valor > 0.4) {
                clase = 'correlacion-positiva';
                texto = 'Correlaci√≥n positiva moderada';
            } else if (valor < -0.7) {
                clase = 'correlacion-negativa';
                texto = 'Correlaci√≥n negativa fuerte';
            } else if (valor < -0.4) {
                clase = 'correlacion-negativa';
                texto = 'Correlaci√≥n negativa moderada';
            }
            
            div.innerHTML = `
                <div class="correlacion-label">${label}</div>
                <div class="correlacion-valor ${clase}">${valor.toFixed(3)}</div>
                <div class="correlacion-interpretacion">${texto}</div>
                <div style="font-size: 11px; margin-top: 5px; opacity: 0.8;">${interpretacion}</div>
            `;
            
            return div;
        }
        
        // ========================================
        // üÜï MEJORA 12: BENCHMARK Y PERCENTILES
        // ========================================
        
        function calcularBenchmark() {
            if (datosFiltrados.length === 0) {
                document.getElementById('benchmark-panel').style.display = 'none';
                return;
            }
            
            // An√°lisis por Unidad
            const actividadesPorUnidad = {};
            datosFiltrados.forEach(row => {
                const distrito = String(row[CONFIG.campos.distrito]);
                let unidadNombre = '';
                
                if (distrito === '0') {
                    const unidadId = String(row[CONFIG.campos.unidad_granada]);
                    unidadNombre = CONFIG.unidades_granada[unidadId];
                } else if (distrito === '1') {
                    const unidadId = String(row[CONFIG.campos.unidad_metro]);
                    unidadNombre = CONFIG.unidades_metro[unidadId];
                }
                
                if (unidadNombre) {
                    if (!actividadesPorUnidad[unidadNombre]) {
                        actividadesPorUnidad[unidadNombre] = 0;
                    }
                    actividadesPorUnidad[unidadNombre]++;
                }
            });
            
            const unidades = Object.entries(actividadesPorUnidad)
                .map(([nombre, actividades]) => ({ nombre, actividades }))
                .sort((a, b) => b.actividades - a.actividades);
            
            // Calcular percentiles
            const valores = unidades.map(u => u.actividades);
            const p25 = calcularPercentil(valores, 25);
            const p50 = calcularPercentil(valores, 50);
            const p75 = calcularPercentil(valores, 75);
            
            const container = document.getElementById('percentiles-grid');
            container.innerHTML = '';
            
            // Categor√≠a: Excelentes (>P75)
            const divExcelente = document.createElement('div');
            divExcelente.className = 'percentil-categoria';
            divExcelente.innerHTML = '<h4>üåü Excelente (Top 25%)</h4>';
            const excelentes = unidades.filter(u => u.actividades >= p75);
            excelentes.forEach(u => {
                divExcelente.innerHTML += crearItemPercentil(u.nombre, u.actividades, 'excelente');
            });
            if (excelentes.length > 0) container.appendChild(divExcelente);
            
            // Categor√≠a: Bueno (P50-P75)
            const divBueno = document.createElement('div');
            divBueno.className = 'percentil-categoria';
            divBueno.innerHTML = '<h4>üëç Bueno (P50-P75)</h4>';
            const buenos = unidades.filter(u => u.actividades >= p50 && u.actividades < p75);
            buenos.forEach(u => {
                divBueno.innerHTML += crearItemPercentil(u.nombre, u.actividades, 'bueno');
            });
            if (buenos.length > 0) container.appendChild(divBueno);
            
            // Categor√≠a: Regular (P25-P50)
            const divRegular = document.createElement('div');
            divRegular.className = 'percentil-categoria';
            divRegular.innerHTML = '<h4>‚ö†Ô∏è Regular (P25-P50)</h4>';
            const regulares = unidades.filter(u => u.actividades >= p25 && u.actividades < p50);
            regulares.forEach(u => {
                divRegular.innerHTML += crearItemPercentil(u.nombre, u.actividades, 'regular');
            });
            if (regulares.length > 0) container.appendChild(divRegular);
            
            // Categor√≠a: Necesita mejora (<P25)
            const divMejorar = document.createElement('div');
            divMejorar.className = 'percentil-categoria';
            divMejorar.innerHTML = '<h4>üîß Necesita Mejora (Bottom 25%)</h4>';
            const mejorar = unidades.filter(u => u.actividades < p25);
            mejorar.forEach(u => {
                divMejorar.innerHTML += crearItemPercentil(u.nombre, u.actividades, 'mejorar');
            });
            if (mejorar.length > 0) container.appendChild(divMejorar);
            
            document.getElementById('benchmark-panel').style.display = 'block';
        }
        
        function calcularPercentil(valores, percentil) {
            if (valores.length === 0) return 0;
            const sorted = [...valores].sort((a, b) => a - b);
            const index = (percentil / 100) * (sorted.length - 1);
            const lower = Math.floor(index);
            const upper = Math.ceil(index);
            const weight = index % 1;
            
            if (lower === upper) return sorted[lower];
            return sorted[lower] * (1 - weight) + sorted[upper] * weight;
        }
        
        function crearItemPercentil(nombre, valor, categoria) {
            const badges = {
                'excelente': 'EXCELENTE',
                'bueno': 'BUENO',
                'regular': 'REGULAR',
                'mejorar': 'MEJORAR'
            };
            
            return `
                <div class="percentil-item percentil-${categoria}">
                    <span class="percentil-nombre">${nombre}</span>
                    <span class="percentil-badge">${badges[categoria]}</span>
                    <span class="percentil-valor">${valor}</span>
                </div>
            `;
        }
        
        // ========================================
        // üÜï MEJORA 13: EXPORTACI√ìN PDF
        // ========================================
        
        function mostrarPanelPDF() {
            const panel = document.getElementById('pdf-panel');
            if (panel) {
                if (datosFiltrados && datosFiltrados.length > 0) {
                    panel.style.display = 'block';
                    console.log('‚úÖ Panel PDF mostrado - Datos disponibles:', datosFiltrados.length, 'registros');
                } else {
                    panel.style.display = 'none';
                    console.log('‚ö†Ô∏è Panel PDF oculto - Sin datos');
                }
            } else {
                console.error('‚ùå Panel PDF no encontrado en el DOM');
            }
        }
        
        // Funci√≥n de acceso r√°pido desde el bot√≥n del header
        function accionRapidaPDF() {
            if (!datosFiltrados || datosFiltrados.length === 0) {
                alert('‚ö†Ô∏è Primero carga un archivo CSV.\n\n1. Click en "üìÅ Cargar archivo CSV"\n2. Selecciona tu archivo\n3. Despu√©s podr√°s generar PDFs');
                return;
            }
            
            // Si hay datos, preguntar qu√© tipo de PDF quiere
            const opcion = confirm('üìÑ ¬øQu√© informe deseas generar?\n\n‚úÖ Aceptar ‚Üí Informe Ejecutivo (r√°pido)\n‚ùå Cancelar ‚Üí Ver todas las opciones');
            
            if (opcion) {
                // Generar directamente el PDF ejecutivo
                generarPDFEjecutivo();
            } else {
                // Hacer scroll al panel para que elija
                const panel = document.getElementById('pdf-panel');
                if (panel) {
                    panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        function generarPDFEjecutivo() {
            try {
                // Verificar que hay datos
                if (!datosFiltrados || datosFiltrados.length === 0) {
                    alert('‚ö†Ô∏è No hay datos cargados.\n\nPor favor, carga un archivo CSV primero.');
                    return;
                }
                
                // Verificar que jsPDF est√° disponible
                if (typeof window.jspdf === 'undefined') {
                    alert('‚ùå Error: La librer√≠a jsPDF no est√° cargada.\n\nPor favor, verifica tu conexi√≥n a internet y recarga la p√°gina.');
                    console.error('jsPDF no est√° disponible en window.jspdf');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // T√≠tulo
                doc.setFontSize(20);
                doc.setTextColor(25, 118, 210);
                doc.text('INFORME EJECUTIVO', 105, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Distrito Sanitario Granada-Metropolitano', 105, 30, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generado: ${new Date().toLocaleString('es-ES')}`, 105, 37, { align: 'center' });
                
                // KPIs
                const metricas = calcularMetricas();
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                let y = 50;
                
                doc.text('METRICAS PRINCIPALES', 20, y);
                y += 10;
                
                doc.setFontSize(10);
                doc.text(`Total de actividades: ${metricas.actividades}`, 20, y);
                y += 7;
                doc.text(`Total de participantes: ${metricas.participantes}`, 20, y);
                y += 7;
                doc.text(`Total de horas: ${metricas.horas}`, 20, y);
                y += 7;
                doc.text(`Total de sesiones: ${metricas.sesiones}`, 20, y);
                y += 7;
                
                // Calcular porcentajes de forma segura
                const pctHombres = metricas.participantes > 0 
                    ? ((metricas.hombres / metricas.participantes) * 100).toFixed(1) 
                    : 0;
                const pctMujeres = metricas.participantes > 0 
                    ? ((metricas.mujeres / metricas.participantes) * 100).toFixed(1) 
                    : 0;
                
                doc.text(`Participantes hombres: ${metricas.hombres} (${pctHombres}%)`, 20, y);
                y += 7;
                doc.text(`Participantes mujeres: ${metricas.mujeres} (${pctMujeres}%)`, 20, y);
                y += 15;
                
                // A√±adir m√°s informaci√≥n
                doc.setFontSize(12);
                doc.text('INDICADORES DE EFICIENCIA', 20, y);
                y += 10;
                
                doc.setFontSize(10);
                const participantesPorActividad = metricas.actividades > 0 
                    ? (metricas.participantes / metricas.actividades).toFixed(1) 
                    : 0;
                const horasPorParticipante = metricas.participantes > 0 
                    ? (metricas.horas / metricas.participantes).toFixed(2) 
                    : 0;
                const sesionesPorActividad = metricas.actividades > 0 
                    ? (metricas.sesiones / metricas.actividades).toFixed(1) 
                    : 0;
                
                doc.text(`Participantes por actividad: ${participantesPorActividad}`, 20, y);
                y += 7;
                doc.text(`Horas por participante: ${horasPorParticipante}`, 20, y);
                y += 7;
                doc.text(`Sesiones por actividad: ${sesionesPorActividad}`, 20, y);
                y += 15;
                
                // Pie de p√°gina
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Dashboard Promocion de la Salud v4.0', 105, 280, { align: 'center' });
                doc.text('Distrito Sanitario Granada-Metropolitano', 105, 285, { align: 'center' });
                
                // Guardar
                const nombreArchivo = `Informe_Ejecutivo_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nombreArchivo);
                
                console.log('‚úÖ PDF generado:', nombreArchivo);
                alert('‚úÖ Informe PDF generado correctamente.\n\nEl archivo se ha descargado: ' + nombreArchivo);
                
            } catch (error) {
                console.error('‚ùå Error al generar PDF:', error);
                alert('‚ùå Error al generar el PDF.\n\nDetalles: ' + error.message + '\n\nPor favor, verifica la consola (F12) para m√°s informaci√≥n.');
            }
        }
        
        function generarPDFCompleto() {
            try {
                if (!datosFiltrados || datosFiltrados.length === 0) {
                    alert('‚ö†Ô∏è No hay datos cargados.\n\nPor favor, carga un archivo CSV primero.');
                    return;
                }
                
                if (typeof window.jspdf === 'undefined') {
                    alert('‚ùå Error: La librer√≠a jsPDF no est√° cargada.\n\nPor favor, verifica tu conexi√≥n a internet y recarga la p√°gina.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // P√°gina 1: Portada
                doc.setFontSize(24);
                doc.setTextColor(25, 118, 210);
                doc.text('INFORME COMPLETO', 105, 40, { align: 'center' });
                
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('Promocion de la Salud', 105, 55, { align: 'center' });
                doc.text('Distrito Sanitario Granada-Metropolitano', 105, 65, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generado: ${new Date().toLocaleString('es-ES')}`, 105, 80, { align: 'center' });
                doc.text(`Datos analizados: ${datosFiltrados.length} actividades`, 105, 90, { align: 'center' });
                
                // P√°gina 2: M√©tricas
                doc.addPage();
                const metricas = calcularMetricas();
                let y = 20;
                
                doc.setFontSize(16);
                doc.setTextColor(25, 118, 210);
                doc.text('1. METRICAS PRINCIPALES', 20, y);
                y += 15;
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Total de actividades: ${metricas.actividades}`, 30, y);
                y += 8;
                doc.text(`Total de participantes: ${metricas.participantes}`, 30, y);
                y += 8;
                doc.text(`Total de horas: ${metricas.horas}`, 30, y);
                y += 8;
                doc.text(`Total de sesiones: ${metricas.sesiones}`, 30, y);
                y += 8;
                doc.text(`Participantes hombres: ${metricas.hombres}`, 30, y);
                y += 8;
                doc.text(`Participantes mujeres: ${metricas.mujeres}`, 30, y);
                y += 20;
                
                // Indicadores de eficiencia
                doc.setFontSize(16);
                doc.setTextColor(25, 118, 210);
                doc.text('2. INDICADORES DE EFICIENCIA', 20, y);
                y += 15;
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                const participantesPorActividad = metricas.actividades > 0 
                    ? (metricas.participantes / metricas.actividades).toFixed(1) 
                    : 0;
                const horasPorParticipante = metricas.participantes > 0 
                    ? (metricas.horas / metricas.participantes).toFixed(2) 
                    : 0;
                const sesionesPorActividad = metricas.actividades > 0 
                    ? (metricas.sesiones / metricas.actividades).toFixed(1) 
                    : 0;
                
                doc.text(`Participantes por actividad: ${participantesPorActividad}`, 30, y);
                y += 8;
                doc.text(`Horas por participante: ${horasPorParticipante}`, 30, y);
                y += 8;
                doc.text(`Sesiones por actividad: ${sesionesPorActividad}`, 30, y);
                
                // Pie de p√°gina
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Dashboard v4.0 - Pagina 2/2', 105, 285, { align: 'center' });
                
                // Guardar
                const nombreArchivo = `Informe_Completo_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nombreArchivo);
                
                console.log('‚úÖ PDF completo generado:', nombreArchivo);
                alert('‚úÖ Informe PDF Completo generado.\n\n' + nombreArchivo);
                
            } catch (error) {
                console.error('‚ùå Error al generar PDF completo:', error);
                alert('‚ùå Error al generar el PDF.\n\nDetalles: ' + error.message);
            }
        }
        
        function generarPDFComparativo() {
            try {
                if (!datosFiltrados || datosFiltrados.length === 0) {
                    alert('‚ö†Ô∏è No hay datos cargados.\n\nPor favor, carga un archivo CSV primero.');
                    return;
                }
                
                alert('‚öñÔ∏è Generando an√°lisis comparativo...\n\nEsta funcionalidad est√° en desarrollo.\n\nPor ahora, usa "Informe Ejecutivo" o "Informe Completo".');
                
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function generarPDFPersonalizado() {
            try {
                if (!datosFiltrados || datosFiltrados.length === 0) {
                    alert('‚ö†Ô∏è No hay datos cargados.\n\nPor favor, carga un archivo CSV primero.');
                    return;
                }
                
                alert('‚öôÔ∏è Modo personalizado...\n\nEsta funcionalidad est√° en desarrollo.\n\nPor ahora, usa "Informe Ejecutivo" o "Informe Completo".');
                
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // ========================================
        // üÜï INFORME PROFESIONAL EXHAUSTIVO
        // ========================================
        
        function generarInformeProfesionalExhaustivo() {
            try {
                // Verificar que estamos en modo profesional
                if (nivelActual !== 'profesional' || !profesionalSeleccionado) {
                    alert('‚ö†Ô∏è Debes estar en modo "Profesional Individual".\n\n1. Selecciona "Profesional Individual" en Nivel de An√°lisis\n2. Elige tu nombre\n3. Vuelve a generar el informe');
                    return;
                }
                
                // Verificar que hay datos
                if (!datosFiltrados || datosFiltrados.length === 0) {
                    alert('‚ö†Ô∏è No hay actividades registradas para este profesional en el per√≠odo seleccionado.');
                    return;
                }
                
                // Verificar jsPDF
                if (typeof window.jspdf === 'undefined') {
                    alert('‚ùå Error: La librer√≠a jsPDF no est√° cargada.\n\nPor favor, verifica tu conexi√≥n y recarga la p√°gina.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Calcular m√©tricas
                const metricas = calcularMetricas();
                let y = 20;
                const margenIzq = 20;
                const margenDer = 190;
                const anchoUtil = margenDer - margenIzq;
                
                // ============================================
                // P√ÅGINA 1: PORTADA
                // ============================================
                
                // Logo/Header
                doc.setFillColor(25, 118, 210);
                doc.rect(0, 0, 210, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('INFORME PROFESIONAL', 105, 20, { align: 'center' });
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'normal');
                doc.text('Promocion de la Salud', 105, 30, { align: 'center' });
                
                // Nombre del profesional
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                y = 60;
                doc.text(profesionalSeleccionado, 105, y, { align: 'center' });
                
                // Informaci√≥n del documento
                y = 75;
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text('Distrito Sanitario Granada-Metropolitano', 105, y, { align: 'center' });
                
                y += 8;
                doc.text(`Periodo analizado: ${datosFiltrados.length} actividades`, 105, y, { align: 'center' });
                
                y += 8;
                doc.text(`Generado: ${new Date().toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                })}`, 105, y, { align: 'center' });
                
                // Resumen ejecutivo en portada
                y = 110;
                doc.setFontSize(14);
                doc.setTextColor(25, 118, 210);
                doc.setFont(undefined, 'bold');
                doc.text('RESUMEN EJECUTIVO', margenIzq, y);
                
                y += 10;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                
                const resumenLineas = [
                    `Total de actividades realizadas: ${metricas.actividades}`,
                    `Participantes impactados: ${metricas.participantes} personas`,
                    `Horas dedicadas: ${metricas.horas} horas`,
                    `Sesiones impartidas: ${metricas.sesiones}`,
                    `Participacion por sexo: ${metricas.hombres} hombres, ${metricas.mujeres} mujeres`
                ];
                
                resumenLineas.forEach(linea => {
                    doc.text(linea, margenIzq, y);
                    y += 7;
                });
                
                // Pie de portada
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('Documento generado automaticamente - Sistema de Gestion de Actividades', 105, 280, { align: 'center' });
                doc.text('Servicio Andaluz de Salud - Distrito Sanitario Granada-Metropolitano', 105, 285, { align: 'center' });
                
                // ============================================
                // P√ÅGINA 2: M√âTRICAS PRINCIPALES
                // ============================================
                
                doc.addPage();
                y = 20;
                
                // T√≠tulo de secci√≥n
                doc.setFillColor(25, 118, 210);
                doc.rect(margenIzq, y-5, anchoUtil, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('1. METRICAS PRINCIPALES', margenIzq + 5, y + 2);
                
                y += 15;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                // KPIs en cajas
                const kpis = [
                    { label: 'Total Actividades', valor: metricas.actividades, icono: 'üìä' },
                    { label: 'Total Participantes', valor: metricas.participantes, icono: 'üë•' },
                    { label: 'Horas Totales', valor: metricas.horas, icono: '‚è±Ô∏è' },
                    { label: 'Sesiones', valor: metricas.sesiones, icono: 'üìÖ' }
                ];
                
                kpis.forEach((kpi, index) => {
                    const col = index % 2;
                    const fila = Math.floor(index / 2);
                    const x = margenIzq + col * 85;
                    const yBox = y + fila * 25;
                    
                    doc.setDrawColor(200, 200, 200);
                    doc.setFillColor(245, 245, 245);
                    doc.roundedRect(x, yBox, 80, 20, 3, 3, 'FD');
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`${kpi.icono} ${kpi.label}`, x + 5, yBox + 7);
                    
                    doc.setFontSize(16);
                    doc.setTextColor(25, 118, 210);
                    doc.setFont(undefined, 'bold');
                    doc.text(String(kpi.valor), x + 5, yBox + 16);
                    doc.setFont(undefined, 'normal');
                });
                
                y += 60;
                
                // Distribuci√≥n por sexo
                doc.setFontSize(12);
                doc.setTextColor(25, 118, 210);
                doc.setFont(undefined, 'bold');
                doc.text('Distribucion de Participantes por Sexo', margenIzq, y);
                
                y += 8;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                
                const pctHombres = metricas.participantes > 0 
                    ? ((metricas.hombres / metricas.participantes) * 100).toFixed(1) 
                    : 0;
                const pctMujeres = metricas.participantes > 0 
                    ? ((metricas.mujeres / metricas.participantes) * 100).toFixed(1) 
                    : 0;
                
                doc.text(`Hombres: ${metricas.hombres} (${pctHombres}%)`, margenIzq + 5, y);
                y += 6;
                doc.text(`Mujeres: ${metricas.mujeres} (${pctMujeres}%)`, margenIzq + 5, y);
                
                // Indicadores de eficiencia
                y += 15;
                doc.setFontSize(12);
                doc.setTextColor(25, 118, 210);
                doc.setFont(undefined, 'bold');
                doc.text('Indicadores de Eficiencia', margenIzq, y);
                
                y += 8;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                
                const participantesPorActividad = metricas.actividades > 0 
                    ? (metricas.participantes / metricas.actividades).toFixed(1) 
                    : 0;
                const horasPorParticipante = metricas.participantes > 0 
                    ? (metricas.horas / metricas.participantes).toFixed(2) 
                    : 0;
                const sesionesPorActividad = metricas.actividades > 0 
                    ? (metricas.sesiones / metricas.actividades).toFixed(1) 
                    : 0;
                
                doc.text(`Media de participantes por actividad: ${participantesPorActividad}`, margenIzq + 5, y);
                y += 6;
                doc.text(`Horas promedio por participante: ${horasPorParticipante}`, margenIzq + 5, y);
                y += 6;
                doc.text(`Sesiones promedio por actividad: ${sesionesPorActividad}`, margenIzq + 5, y);
                
                // Pie de p√°gina
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`${profesionalSeleccionado} - Pagina 2`, 105, 285, { align: 'center' });
                
                // ============================================
                // P√ÅGINA 3: DISTRIBUCI√ìN DE ACTIVIDADES
                // ============================================
                
                doc.addPage();
                y = 20;
                
                // T√≠tulo
                doc.setFillColor(25, 118, 210);
                doc.rect(margenIzq, y-5, anchoUtil, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('2. DISTRIBUCION DE ACTIVIDADES', margenIzq + 5, y + 2);
                
                y += 15;
                
                // Por tipo de actividad
                doc.setFontSize(12);
                doc.setTextColor(25, 118, 210);
                doc.setFont(undefined, 'bold');
                doc.text('Por Tipo de Actividad', margenIzq, y);
                
                y += 8;
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                
                const tiposConteo = {};
                datosFiltrados.forEach(row => {
                    const tipo = row[CONFIG.campos.tipo_actividad];
                    const nombre = CONFIG.tipos_actividad[tipo] || 'Sin especificar';
                    tiposConteo[nombre] = (tiposConteo[nombre] || 0) + 1;
                });
                
                const tiposOrdenados = Object.entries(tiposConteo)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                tiposOrdenados.forEach(([tipo, count]) => {
                    if (y > 260) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(`${tipo}: ${count}`, margenIzq + 5, y);
                    y += 5;
                });
                
                y += 5;
                
                // Por tem√°tica
                doc.setFontSize(12);
                doc.setTextColor(25, 118, 210);
                doc.setFont(undefined, 'bold');
                doc.text('Por Tematica', margenIzq, y);
                
                y += 8;
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                
                const tematicasConteo = {};
                datosFiltrados.forEach(row => {
                    const tem = row[CONFIG.campos.tematica];
                    const nombre = CONFIG.tematicas[tem] || 'Sin especificar';
                    tematicasConteo[nombre] = (tematicasConteo[nombre] || 0) + 1;
                });
                
                const tematicasOrdenadas = Object.entries(tematicasConteo)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                tematicasOrdenadas.forEach(([tematica, count]) => {
                    if (y > 260) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(`${tematica}: ${count}`, margenIzq + 5, y);
                    y += 5;
                });
                
                // Pie de p√°gina
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`${profesionalSeleccionado} - Pagina 3`, 105, 285, { align: 'center' });
                
                // ============================================
                // P√ÅGINA 4: LISTADO DETALLADO DE ACTIVIDADES
                // ============================================
                
                doc.addPage();
                y = 20;
                
                // T√≠tulo
                doc.setFillColor(25, 118, 210);
                doc.rect(margenIzq, y-5, anchoUtil, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('3. LISTADO DETALLADO DE ACTIVIDADES', margenIzq + 5, y + 2);
                
                y += 15;
                
                // Tabla de actividades
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                
                // Encabezados
                doc.setFont(undefined, 'bold');
                doc.text('Fecha', margenIzq, y);
                doc.text('Actividad', margenIzq + 25, y);
                doc.text('Tipo', margenIzq + 85, y);
                doc.text('Part.', margenIzq + 130, y);
                doc.text('Hrs', margenIzq + 150, y);
                doc.text('Ses', margenIzq + 165, y);
                
                y += 2;
                doc.setDrawColor(200, 200, 200);
                doc.line(margenIzq, y, margenDer, y);
                y += 4;
                
                doc.setFont(undefined, 'normal');
                
                datosFiltrados.forEach((row, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                        // Repetir encabezados
                        doc.setFont(undefined, 'bold');
                        doc.text('Fecha', margenIzq, y);
                        doc.text('Actividad', margenIzq + 25, y);
                        doc.text('Tipo', margenIzq + 85, y);
                        doc.text('Part.', margenIzq + 130, y);
                        doc.text('Hrs', margenIzq + 150, y);
                        doc.text('Ses', margenIzq + 165, y);
                        y += 2;
                        doc.line(margenIzq, y, margenDer, y);
                        y += 4;
                        doc.setFont(undefined, 'normal');
                    }
                    
                    const fecha = row[CONFIG.campos.fecha_inicio] || '';
                    let nombreActividad = row[CONFIG.campos.nombre_actividad] || 'Sin nombre';
                    if (nombreActividad.length > 25) nombreActividad = nombreActividad.substring(0, 22) + '...';
                    
                    const tipoId = row[CONFIG.campos.tipo_actividad];
                    let tipoNombre = CONFIG.tipos_actividad[tipoId] || 'N/A';
                    if (tipoNombre.length > 20) tipoNombre = tipoNombre.substring(0, 17) + '...';
                    
                    const participantes = row[CONFIG.campos.participantes] || '0';
                    const horas = row[CONFIG.campos.horas] || '0';
                    const sesiones = row[CONFIG.campos.sesiones] || '0';
                    
                    doc.text(fecha, margenIzq, y);
                    doc.text(nombreActividad, margenIzq + 25, y);
                    doc.text(tipoNombre, margenIzq + 85, y);
                    doc.text(String(participantes), margenIzq + 130, y);
                    doc.text(String(horas), margenIzq + 150, y);
                    doc.text(String(sesiones), margenIzq + 165, y);
                    
                    y += 5;
                });
                
                // N√∫mero de p√°gina actual
                const paginaActual = doc.internal.getNumberOfPages();
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`${profesionalSeleccionado} - Pagina ${paginaActual}`, 105, 285, { align: 'center' });
                
                // ============================================
                // P√ÅGINA FINAL: CONCLUSIONES
                // ============================================
                
                doc.addPage();
                y = 20;
                
                // T√≠tulo
                doc.setFillColor(25, 118, 210);
                doc.rect(margenIzq, y-5, anchoUtil, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('4. CONCLUSIONES Y CUMPLIMIENTO DE OBJETIVOS', margenIzq + 5, y + 2);
                
                y += 15;
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                
                const conclusiones = [
                    `Durante el periodo analizado, ${profesionalSeleccionado} ha realizado un total de`,
                    `${metricas.actividades} actividades de promocion de la salud, impactando directamente a`,
                    `${metricas.participantes} participantes a traves de ${metricas.sesiones} sesiones`,
                    `y ${metricas.horas} horas de trabajo directo con la poblacion.`,
                    '',
                    'Este informe constituye evidencia documentada del cumplimiento de los objetivos',
                    'de promocion de la salud establecidos para el profesional, demostrando el',
                    'compromiso activo en la mejora de la salud de la poblacion del distrito.'
                ];
                
                conclusiones.forEach(linea => {
                    doc.text(linea, margenIzq, y);
                    y += 6;
                });
                
                y += 10;
                
                // Sello/Firma
                doc.setDrawColor(25, 118, 210);
                doc.setLineWidth(0.5);
                doc.rect(margenIzq, y, anchoUtil, 40);
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('Documento generado automaticamente el:', margenIzq + 5, y + 10);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(25, 118, 210);
                doc.text(new Date().toLocaleString('es-ES'), margenIzq + 5, y + 17);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text('Sistema de Gestion de Actividades de Promocion de la Salud', margenIzq + 5, y + 28);
                doc.text('Distrito Sanitario Granada-Metropolitano', margenIzq + 5, y + 34);
                
                // Pie de p√°gina final
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`${profesionalSeleccionado} - Pagina ${doc.internal.getNumberOfPages()}`, 105, 285, { align: 'center' });
                
                // ============================================
                // GUARDAR PDF
                // ============================================
                
                const nombreArchivo = `Informe_Profesional_${profesionalSeleccionado.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nombreArchivo);
                
                console.log('‚úÖ Informe profesional generado:', nombreArchivo);
                alert(`‚úÖ Informe Profesional Generado Exitosamente\n\nArchivo: ${nombreArchivo}\n\nContenido:\n‚Ä¢ Portada profesional\n‚Ä¢ Metricas principales\n‚Ä¢ Distribucion de actividades\n‚Ä¢ Listado completo detallado\n‚Ä¢ Conclusiones\n\nEste documento sirve como evidencia oficial para justificar el cumplimiento de objetivos.`);
                
            } catch (error) {
                console.error('‚ùå Error al generar informe profesional:', error);
                alert('‚ùå Error al generar el informe.\n\nDetalles: ' + error.message);
            }
        }
        
        // ========================================
        // üÜï MEJORA 14: MODO COMPARACI√ìN
        // ========================================
        
        function inicializarModoComparacion() {
            // Poblar selectores con unidades
            const select1 = document.getElementById('comparacion-entidad1');
            const select2 = document.getElementById('comparacion-entidad2');
            
            // Limpiar
            select1.innerHTML = '<option value="">-- Seleccionar --</option>';
            select2.innerHTML = '<option value="">-- Seleccionar --</option>';
            
            // A√±adir unidades Granada
            Object.entries(CONFIG.unidades_granada).forEach(([id, nombre]) => {
                select1.innerHTML += `<option value="granada-${id}">${nombre} (Granada)</option>`;
                select2.innerHTML += `<option value="granada-${id}">${nombre} (Granada)</option>`;
            });
            
            // A√±adir unidades Metro
            Object.entries(CONFIG.unidades_metro).forEach(([id, nombre]) => {
                select1.innerHTML += `<option value="metro-${id}">${nombre} (Metro)</option>`;
                select2.innerHTML += `<option value="metro-${id}">${nombre} (Metro)</option>`;
            });
            
            document.getElementById('comparacion-panel').style.display = 'block';
        }
        
        function actualizarComparacion() {
            const entidad1 = document.getElementById('comparacion-entidad1').value;
            const entidad2 = document.getElementById('comparacion-entidad2').value;
            
            if (!entidad1 || !entidad2) {
                document.getElementById('comparacion-resultados').innerHTML = '';
                return;
            }
            
            const datos1 = obtenerDatosEntidad(entidad1);
            const datos2 = obtenerDatosEntidad(entidad2);
            
            const container = document.getElementById('comparacion-resultados');
            container.innerHTML = `
                <div class="comparacion-entidad">
                    <div class="comparacion-entidad-nombre">${datos1.nombre}</div>
                    ${crearMetricasComparacion(datos1.metricas, datos2.metricas, true)}
                </div>
                <div class="comparacion-entidad">
                    <div class="comparacion-entidad-nombre">${datos2.nombre}</div>
                    ${crearMetricasComparacion(datos2.metricas, datos1.metricas, false)}
                </div>
            `;
        }
        
        function obtenerDatosEntidad(entidadId) {
            const [tipo, id] = entidadId.split('-');
            let nombre = '';
            let filtrados = [];
            
            if (tipo === 'granada') {
                nombre = CONFIG.unidades_granada[id];
                filtrados = datosFiltrados.filter(r => 
                    String(r[CONFIG.campos.distrito]) === '0' && 
                    String(r[CONFIG.campos.unidad_granada]) === id
                );
            } else {
                nombre = CONFIG.unidades_metro[id];
                filtrados = datosFiltrados.filter(r => 
                    String(r[CONFIG.campos.distrito]) === '1' && 
                    String(r[CONFIG.campos.unidad_metro]) === id
                );
            }
            
            const metricas = {
                actividades: filtrados.length,
                participantes: filtrados.reduce((sum, r) => sum + (parseInt(r[CONFIG.campos.participantes]) || 0), 0),
                horas: filtrados.reduce((sum, r) => sum + (parseInt(r[CONFIG.campos.horas]) || 0), 0),
                sesiones: filtrados.reduce((sum, r) => sum + (parseInt(r[CONFIG.campos.sesiones]) || 0), 0)
            };
            
            return { nombre, metricas };
        }
        
        function crearMetricasComparacion(metricas, metricasOtra, esIzquierda) {
            const comparaciones = [
                { label: 'Actividades', valor: metricas.actividades, otro: metricasOtra.actividades },
                { label: 'Participantes', valor: metricas.participantes, otro: metricasOtra.participantes },
                { label: 'Horas totales', valor: metricas.horas, otro: metricasOtra.horas },
                { label: 'Sesiones', valor: metricas.sesiones, otro: metricasOtra.sesiones }
            ];
            
            return comparaciones.map(c => {
                const ganador = c.valor > c.otro;
                return `
                    <div class="comparacion-metrica ${ganador ? 'comparacion-ganador' : ''}">
                        <span class="comparacion-metrica-label">${c.label}</span>
                        <span class="comparacion-metrica-valor">${c.valor} ${ganador ? 'üëë' : ''}</span>
                    </div>
                `;
            }).join('');
        }
        
        // ========================================
        // üÜï MEJORA 15: B√öSQUEDA AVANZADA
        // ========================================
        
        function inicializarBusquedaAvanzada() {
            // Poblar selectores
            const selectTematica = document.getElementById('busqueda-tematica');
            const selectTipo = document.getElementById('busqueda-tipo');
            
            // Tem√°ticas
            Object.entries(CONFIG.tematicas).forEach(([id, nombre]) => {
                selectTematica.innerHTML += `<option value="${id}">${nombre}</option>`;
            });
            
            // Tipos
            Object.entries(CONFIG.tipos_actividad).forEach(([id, nombre]) => {
                selectTipo.innerHTML += `<option value="${id}">${nombre}</option>`;
            });
            
            document.getElementById('busqueda-panel').style.display = 'block';
        }
        
        function aplicarBusquedaAvanzada() {
            // Guardar los criterios de b√∫squeda avanzada
            criteriosBusquedaAvanzada = {
                profesional: document.getElementById('busqueda-profesional').value.toLowerCase(),
                actividad: document.getElementById('busqueda-actividad').value.toLowerCase(),
                tematica: document.getElementById('busqueda-tematica').value,
                tipo: document.getElementById('busqueda-tipo').value,
                minParticipantes: parseInt(document.getElementById('busqueda-min-participantes').value) || 0,
                zona: document.getElementById('busqueda-zona').value
            };
            
            // Verificar si hay alg√∫n criterio activo
            const hayCriterios = criteriosBusquedaAvanzada.profesional || 
                                 criteriosBusquedaAvanzada.actividad || 
                                 criteriosBusquedaAvanzada.tematica || 
                                 criteriosBusquedaAvanzada.tipo || 
                                 criteriosBusquedaAvanzada.minParticipantes > 0 || 
                                 criteriosBusquedaAvanzada.zona;
            
            if (!hayCriterios) {
                alert('‚ö†Ô∏è Por favor, introduce al menos un criterio de b√∫squeda.');
                return;
            }
            
            // Aplicar filtros (que ahora incluyen los criterios de b√∫squeda avanzada)
            aplicarFiltros();
            
            // Mostrar informaci√≥n de b√∫squeda
            document.getElementById('busqueda-info').style.display = 'flex';
            document.getElementById('busqueda-contador').textContent = 
                `‚úì ${datosFiltrados.length} resultado${datosFiltrados.length !== 1 ? 's' : ''} encontrado${datosFiltrados.length !== 1 ? 's' : ''}`;
        }
        
        function limpiarBusquedaAvanzada() {
            // Limpiar campos
            document.getElementById('busqueda-profesional').value = '';
            document.getElementById('busqueda-actividad').value = '';
            document.getElementById('busqueda-tematica').value = '';
            document.getElementById('busqueda-tipo').value = '';
            document.getElementById('busqueda-min-participantes').value = '';
            document.getElementById('busqueda-zona').value = '';
            
            // üÜï Limpiar criterios guardados
            criteriosBusquedaAvanzada = null;
            
            // Ocultar info
            document.getElementById('busqueda-info').style.display = 'none';
            
            // Restaurar datos aplicando solo los filtros normales
            aplicarFiltros();
        }
        
        // ========================================
        // üóëÔ∏è FUNCI√ìN PARA LIMPIAR TODOS LOS DATOS
        // ========================================
        
        function limpiarDatos() {
            // Confirmar con el usuario
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres limpiar todos los datos cargados?\n\nEsto eliminar√°:\n- Todos los datos del CSV\n- Los filtros aplicados\n- Las b√∫squedas activas\n\nLos perfiles guardados se mantendr√°n.')) {
                return;
            }
            
            try {
                // Limpiar arrays de datos
                datosOriginales = [];
                datosFiltrados = [];
                
                // Resetear input de archivo
                const fileInput = document.getElementById('file-input');
                if (fileInput) fileInput.value = '';
                
                // Limpiar todos los filtros - con verificaci√≥n
                const filtros = [
                    'filtro-fecha-desde', 
                    'filtro-fecha-hasta', 
                    'filtro-tipo-actividad', 
                    'filtro-tematica', 
                    'filtro-programa'
                ];
                filtros.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.value = '';
                });
                
                // Resetear nivel de an√°lisis - con verificaci√≥n
                const nivelAgg = document.getElementById('nivel-agregacion');
                if (nivelAgg) nivelAgg.value = 'global';
                
                const selectUnidad = document.getElementById('select-unidad');
                if (selectUnidad) selectUnidad.value = '';
                
                const selectProf = document.getElementById('select-profesional');
                if (selectProf) selectProf.value = '';
                
                const grupoUnidad = document.getElementById('grupo-unidad');
                if (grupoUnidad) grupoUnidad.style.display = 'none';
                
                const grupoProf = document.getElementById('grupo-profesional');
                if (grupoProf) grupoProf.style.display = 'none';
                
                // Actualizar el texto del nivel actual
                const nivelActualTexto = document.getElementById('nivel-actual-texto');
                if (nivelActualTexto) {
                    nivelActualTexto.textContent = 'Distrito Sanitario Granada-Metropolitano (Total)';
                }
                
                // Limpiar b√∫squeda avanzada - con verificaci√≥n
                const busquedas = [
                    'busqueda-profesional',
                    'busqueda-actividad',
                    'busqueda-tematica',
                    'busqueda-tipo',
                    'busqueda-min-participantes',
                    'busqueda-zona'
                ];
                busquedas.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.value = '';
                });
                
                const busquedaInfo = document.getElementById('busqueda-info');
                if (busquedaInfo) busquedaInfo.style.display = 'none';
                
                // Ocultar todos los paneles - con verificaci√≥n
                const paneles = [
                    'alertas-panel',
                    'comparativas-panel',
                    'dashboard-profesional',
                    'brechas-panel',
                    'perfiles-panel',
                    'eficiencia-panel',
                    'predictivo-panel',
                    'correlaciones-panel',
                    'benchmark-panel',
                    'pdf-panel',
                    'comparacion-panel',
                    'busqueda-panel'
                ];
                paneles.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.style.display = 'none';
                });
                
                // Limpiar KPIs - con verificaci√≥n
                const kpis = [
                    'kpi-actividades',
                    'kpi-participantes',
                    'kpi-horas',
                    'kpi-sesiones',
                    'kpi-hombres',
                    'kpi-mujeres'
                ];
                kpis.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.textContent = '0';
                });
                
                // Destruir gr√°ficos existentes
                const graficos = [
                    'chartTipos',
                    'chartTematicas',
                    'chartProgramas',
                    'chartGenero',
                    'chartDistritoComparativa',
                    'chartEvolucion',
                    'chartPredictivo'
                ];
                graficos.forEach(chart => {
                    if (window[chart] && typeof window[chart].destroy === 'function') {
                        window[chart].destroy();
                    }
                });
                
                // Limpiar rankings - con verificaci√≥n
                const rankingProf = document.getElementById('ranking-profesionales');
                if (rankingProf) rankingProf.innerHTML = '';
                
                const rankingTipos = document.getElementById('ranking-tipos');
                if (rankingTipos) rankingTipos.innerHTML = '';
                
                // Limpiar tablas - con verificaci√≥n
                const tablaGranadaBody = document.getElementById('tabla-granada-body');
                if (tablaGranadaBody) tablaGranadaBody.innerHTML = '';
                
                const tablaMetroBody = document.getElementById('tabla-metro-body');
                if (tablaMetroBody) tablaMetroBody.innerHTML = '';
                
                const tablaInfoGranada = document.getElementById('tabla-info-granada');
                if (tablaInfoGranada) tablaInfoGranada.textContent = 'Mostrando 0 de 0 actividades';
                
                const tablaInfoMetro = document.getElementById('tabla-info-metro');
                if (tablaInfoMetro) tablaInfoMetro.textContent = 'Mostrando 0 de 0 actividades';
                
                // Resetear variables de paginaci√≥n (si existen)
                if (typeof paginaActualGranada !== 'undefined') paginaActualGranada = 1;
                if (typeof paginaActualMetro !== 'undefined') paginaActualMetro = 1;
                
                // Mostrar mensaje de √©xito
                alert('‚úÖ Datos limpiados correctamente.\n\nPuedes cargar un nuevo archivo CSV usando el bot√≥n "üìÅ Cargar archivo CSV".');
                
                console.log('üóëÔ∏è Datos limpiados. Dashboard reseteado.');
                
            } catch (error) {
                console.error('‚ùå Error al limpiar datos:', error);
                alert('‚ö†Ô∏è Ocurri√≥ un error al limpiar los datos. Por favor, recarga la p√°gina.\n\nError: ' + error.message);
            }
        }
        
        // Event listener para el bot√≥n de limpiar datos
        const btnLimpiarDatos = document.getElementById('btn-limpiar-datos');
        if (btnLimpiarDatos) {
            btnLimpiarDatos.addEventListener('click', limpiarDatos);
            console.log('‚úÖ Bot√≥n "Limpiar datos" conectado correctamente');
        } else {
            console.error('‚ùå No se encontr√≥ el bot√≥n "btn-limpiar-datos"');
        }
        
        // ===========================
        // INICIALIZACI√ìN
        // ===========================
        cargarPerfiles(); // Cargar perfiles guardados al iniciar
        console.log('Registro de actuaciones de promoci√≥n de la salud - Dashboard v4.0 üöÄ inicializado. Carga un archivo CSV para comenzar.');
    </script>
</body>
</html>
